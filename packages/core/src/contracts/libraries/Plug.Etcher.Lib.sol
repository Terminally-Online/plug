// SPDX-License-Identifier: MIT

pragma solidity 0.8.23;

import { PlugLib } from "../libraries/Plug.Lib.sol";
import { PlugFactory } from "../base/Plug.Factory.sol";
import { PlugSocket } from "../base/Plug.Socket.sol";
import { Plug } from "../base/Plug.sol";

interface ImmutableCreate2Factory {
    function safeCreate2(
        bytes32 salt,
        bytes calldata initCode
    )
        external
        payable
        returns (address deploymentAddress);

    function findCreate2Address(
        bytes32 salt,
        bytes calldata initCode
    )
        external
        view
        returns (address deploymentAddress);

    function findCreate2AddressViaHash(
        bytes32 salt,
        bytes32 initCodeHash
    )
        external
        view
        returns (address deploymentAddress);
}

/**
 * @title Plug Etcher
 * @notice This contract is the basis of the automatically generated Plug Etcher
 *         contract used to deploy and write the proper addresses. If you need to add
 *         a new etch into the vm stack for testing, you will do so through the file
 *         found at: /lib/functions/etcher.ts
 * @notice A good portion of this model comes from:
 *         https://github.com/Vectorized/multicaller/blob/main/src/MulticallerEtcher.sol
 *         I am not a Foundry expert. If there is a better way to do this, please let me
 *         know because this is a lot of work just to get a contract deployed when you're
 *         doing anything more than a simple in-and-out contract.
 * @author vectorized (twitter:@optimizoor)
 */
library PlugEtcherLib {
    /// @notice The immutable Create2 factory used for deployment.
    ImmutableCreate2Factory internal constant FACTORY =
        ImmutableCreate2Factory(0x0000000000FFe8B47B3e2130213B802212439497);

    bytes internal constant PLUG_FACTORY_INITCODE =
        hex"608060405234801561001057600080fd5b506106e5806100206000396000f3fe6080604052600436106100335760003560e01c80627743601461003857806375fd9f281461007c5780637ac4ed641461011a575b600080fd5b61004b610046366004610546565b61015f565b60408051921515835273ffffffffffffffffffffffffffffffffffffffff9091166020830152015b60405180910390f35b34801561008857600080fd5b5061010c6100973660046105dd565b604080517fcc3735a920a3ca505d382bbc545af43d6000803e6038573d6000fd5b3d6000f360609081527f5155f3363d3d373d3d363d7f360894a13ba1a3210667c828492db98dca3e20768352616009602052601e9390935268603d3d8160223d3973600a52605f6021209152600090915290565b604051908152602001610073565b34801561012657600080fd5b5061013a6101353660046105fa565b61039a565b60405173ffffffffffffffffffffffffffffffffffffffff9091168152602001610073565b6000808080808061017287890189610626565b9296509094509250905073ffffffffffffffffffffffffffffffffffffffff811615806101b3575073ffffffffffffffffffffffffffffffffffffffff8316155b1561020e576040517f54f044c400000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff80831660048301528416602482015260440160405180910390fd5b604080517fffffffffffffffffffffffff000000000000000000000000000000000000000060a087901b1660208201527fffffffffffffffffffffffffffffffffffffffff000000000000000000000000606086901b16602c8201526000910160405160208183030381529060405261028690610693565b90506102933483836103ae565b90975095508661038e578373ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167f32c7564be3bbeabe66360c08d019367b0d744fcb948046d92552c00c9743dd10836040516102fc91815260200190565b60405180910390a36040517f485cc95500000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff8581166004830152848116602483015287169063485cc95590604401600060405180830381600087803b15801561037557600080fd5b505af1158015610389573d6000803e3d6000fd5b505050505b50505050509250929050565b60006103a7838330610492565b9392505050565b6000806040517fcc3735a920a3ca505d382bbc545af43d6000803e6038573d6000fd5b3d6000f36060527f5155f3363d3d373d3d363d7f360894a13ba1a3210667c828492db98dca3e207660405261600960205284601e5268603d3d8160223d3973600a52605f60212060358201523060581b815260ff8153836015820152605581209150813b61045a5783605f602188f59150816104555763301164256000526004601cfd5b610480565b6001925085156104805760003860003889865af16104805763b12d13eb6000526004601cfd5b80604052506000606052935093915050565b60008061050e85604080517fcc3735a920a3ca505d382bbc545af43d6000803e6038573d6000fd5b3d6000f360609081527f5155f3363d3d373d3d363d7f360894a13ba1a3210667c828492db98dca3e20768352616009602052601e9390935268603d3d8160223d3973600a52605f6021209152600090915290565b905061051b818585610524565b95945050505050565b600060ff60005350603592835260601b60015260155260556000908120915290565b6000806020838503121561055957600080fd5b823567ffffffffffffffff8082111561057157600080fd5b818501915085601f83011261058557600080fd5b81358181111561059457600080fd5b8660208285010111156105a657600080fd5b60209290920196919550909350505050565b73ffffffffffffffffffffffffffffffffffffffff811681146105da57600080fd5b50565b6000602082840312156105ef57600080fd5b81356103a7816105b8565b6000806040838503121561060d57600080fd5b8235610618816105b8565b946020939093013593505050565b6000806000806080858703121561063c57600080fd5b84356bffffffffffffffffffffffff8116811461065857600080fd5b93506020850135610668816105b8565b92506040850135610678816105b8565b91506060850135610688816105b8565b939692955090935050565b805160208083015191908110156106d2577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8160200360031b1b821691505b5091905056fea164736f6c6343000817000a";

    bytes32 internal constant PLUG_FACTORY_SALT =
        0x0000000000000000000000000000000000000000b5b8eac645e2ff3f6eea9d7d;

    address internal constant PLUG_FACTORY_ADDRESS = 0x002Ad07234d683525284287c2F921788a699D4A5;

    bytes internal constant PLUG_SOCKET_INITCODE =
        hex"60a0604052306080523480156200001557600080fd5b506200002360018062000029565b620000ab565b62000034826200006f565b6001600160a01b038116156200006b576001600160a01b0381166000908152600160208190526040909120805460ff191690911790555b5050565b6001600160a01b0316638b78c6d8198190558060007f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08180a350565b6080516120a8620000ce600039600081816106f401526107da01526120a86000f3fe6080604052600436106101a55760003560e01c8063715018a6116100e1578063cd6a4b851161008a578063dfe86ac511610064578063dfe86ac5146104ce578063f04e283e146104e4578063f2fde38b146104f7578063fee81cf41461050a576101ac565b8063cd6a4b851461047b578063ce4e1bb31461049b578063dcfd71a4146104bb576101ac565b8063967db62b116100bb578063967db62b146104195780639ebde42a14610439578063c2fb26a614610459576101ac565b8063715018a6146103e35780638da5cb5b146103eb57806395d89b4114610404576101ac565b806352d1902d1161014e57806360cd27ad1161012857806360cd27ad1461031e5780636f58509c1461035e5780636f69f3d6146103a35780636fa32e5d146103c3576101ac565b806352d1902d146102bb57806354d1f13d146102d057806354fd4d50146102d8576101ac565b806334bb37001161017f57806334bb370014610268578063485cc955146102885780634f1ef286146102a8576101ac565b806306fdde03146101da5780632569296214610232578063314cdf111461023a576101ac565b366101ac57005b60003560e01c63bc197c81811463f23a6e6182141763150b7a02821417156101d857806020526020603cf35b005b3480156101e657600080fd5b5060408051808201909152600b81527f506c756720536f636b657400000000000000000000000000000000000000000060208201525b60405161022991906115f9565b60405180910390f35b6101d861053d565b34801561024657600080fd5b5061025a610255366004611934565b61058d565b604051908152602001610229565b34801561027457600080fd5b5061025a610283366004611969565b6105f1565b34801561029457600080fd5b506101d86102a3366004611a1b565b610677565b6101d86102b6366004611a54565b6106f2565b3480156102c757600080fd5b5061025a6107d6565b6101d8610835565b3480156102e457600080fd5b5060408051808201909152600581527f302e302e31000000000000000000000000000000000000000000000000000000602082015261021c565b34801561032a57600080fd5b5061034e610339366004611ad9565b60016020526000908152604090205460ff1681565b6040519015158152602001610229565b34801561036a57600080fd5b5061037e610379366004611af6565b610871565b60405173ffffffffffffffffffffffffffffffffffffffff9091168152602001610229565b3480156103af57600080fd5b506101d86103be366004611be9565b610894565b3480156103cf57600080fd5b5061025a6103de366004611934565b610954565b6101d86109e9565b3480156103f757600080fd5b50638b78c6d8195461037e565b34801561041057600080fd5b5061021c6109fd565b34801561042557600080fd5b5061025a610434366004611c55565b610ab7565b34801561044557600080fd5b5061025a610454366004611c8a565b610b29565b34801561046557600080fd5b5061046e610bbc565b6040516102299190611cbf565b34801561048757600080fd5b5061025a610496366004611af6565b610c8c565b6104ae6104a9366004611d4d565b610ce8565b6040516102299190611d88565b6104ae6104c9366004611db0565b610dc7565b3480156104da57600080fd5b5061025a60005481565b6101d86104f2366004611ad9565b610eac565b6101d8610505366004611ad9565b610eec565b34801561051657600080fd5b5061025a610525366004611ad9565b63389a75e1600c908152600091909152602090205490565b60006202a30067ffffffffffffffff164201905063389a75e1600c5233600052806020600c2055337fdbf36a107da19e49527a7176a1babf963b4b0ff8cde35ee35d6cd8f1f9ac7e1d600080a250565b6000805461059a83610954565b6040517f19010000000000000000000000000000000000000000000000000000000000006020820152602281019290925260428201526062015b604051602081830303815290604052805190602001209050919050565b805180516020918201208183015180519083012060408085015160608087015183517f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f978101979097529286019490945292840191909152608083019190915273ffffffffffffffffffffffffffffffffffffffff1660a082015260009060c0016105d4565b61068082610f13565b73ffffffffffffffffffffffffffffffffffffffff8116156106ee5773ffffffffffffffffffffffffffffffffffffffff8116600090815260016020819052604090912080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff001690911790555b5050565b7f000000000000000000000000000000000000000000000000000000000000000030810361072857639f03a0266000526004601cfd5b61073184610f5c565b8360601b60601c93506352d1902d6001527f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc80602060016004601d895afa5114610783576355299b496001526004601dfd5b847fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b600038a284905581156107d057604051828482376000388483885af46107ce573d6000823e3d81fd5b505b50505050565b60007f000000000000000000000000000000000000000000000000000000000000000030811461080e57639f03a0266000526004601cfd5b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc91505090565b63389a75e1600c523360005260006020600c2055337ffa7b8eab7da67f412cc9575ed43464468f9bfbae89d1675917346ca6d8fe3c92600080a2565b600061088e8260200151610888846000015161058d565b90610f64565b92915050565b61089c61100e565b60005b838110156107ce578282828181106108b9576108b9611dec565b90506020020160208101906108ce9190611e1b565b600160008787858181106108e4576108e4611dec565b90506020020160208101906108f99190611ad9565b73ffffffffffffffffffffffffffffffffffffffff168152602081019190915260400160002080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff001691151591909117905560010161089f565b805160208201516000917f21d9aad82642dd8dfaeb7db6b2859f4f99cb1dbffb9a79e03acb22559f4163ef9161098990610b29565b8460400151805190602001208560600151805190602001206040516020016105d495949392919094855273ffffffffffffffffffffffffffffffffffffffff93909316602085015260408401919091526060830152608082015260a00190565b6109f161100e565b6109fb6000611029565b565b60606000610a3b60408051808201909152600b81527f506c756720536f636b6574000000000000000000000000000000000000000000602082015290565b9050805160405181815260208301602082016000805b85811015610a83578084015160001a605b8110604082111615610a7a5780838501536001830192505b50600101610a51565b506005811115610a91575060055b80610aa2575064504c554753815260045b80845283016020016040525090949350505050565b805160208083015180519082012060408085015181517f25770127c481dfef68b980626cb3fc78209bd21a1ced73c324bcd4f9d493adf29481019490945273ffffffffffffffffffffffffffffffffffffffff909416908301526060820152608081019190915260009060a0016105d4565b60006060600080845190505b80821015610bac5782610b60868481518110610b5357610b53611dec565b6020026020010151610ab7565b604051602001610b71929190611e3d565b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181529190529250600190910190610b35565b5050805160209091012092915050565b610bfd6040518060800160405280606081526020016060815260200160008152602001600073ffffffffffffffffffffffffffffffffffffffff1681525090565b6040805160c08101909152600b608082019081527f506c756720536f636b657400000000000000000000000000000000000000000060a083015281908152602001610c7860408051808201909152600581527f302e302e31000000000000000000000000000000000000000000000000000000602082015290565b815246602082015230604090910152919050565b80516000907f069bef582a320c52b1a840b77f073b4862cef3e4776ec09502d6d2738fb45cdd90610cbc90610954565b6020808501518051908201206040516105d4949392019283526020830191909152604082015260600190565b6040805180820190915260008152606060208201523068929eee149b4bd212685403610d1c5763ab143c066000526004601cfd5b3068929eee149b4bd2126855610d3133611074565b1515600003610daa57604080517fcd0e140100000000000000000000000000000000000000000000000000000000815260ff60048201526024810191909152601760448201527f506c7567436f72653a73656e6465722d696e76616c696400000000000000000060648201526084015b60405180910390fd5b610db58260006110d6565b3868929eee149b4bd212685592915050565b6040805180820190915260008152606060208201523068929eee149b4bd212685403610dfb5763ab143c066000526004601cfd5b3068929eee149b4bd212685582610e11816113dc565b1515600003610e8557604080517fcd0e140100000000000000000000000000000000000000000000000000000000815260ff60048201526024810191909152601a60448201527f506c7567436f72653a7369676e61747572652d696e76616c69640000000000006064820152608401610da1565b610e98610e928580611e5f565b846110d6565b3868929eee149b4bd2126855949350505050565b610eb461100e565b63389a75e1600c52806000526020600c208054421115610edc57636f5e88186000526004601cfd5b60009055610ee981611029565b50565b610ef461100e565b8060601b610f0a57637448fbae6000526004601cfd5b610ee981611029565b73ffffffffffffffffffffffffffffffffffffffff16638b78c6d8198190558060007f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08180a350565b610ee961100e565b6040516001908360005260208301516040526040835103610fb957604083015160ff81901c601b016020527f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff16606052610fdf565b6041835103610fda57606083015160001a6020526040830151606052610fdf565b600091505b6020600160806000855afa5191503d61100057638baa579f6000526004601cfd5b600060605260405292915050565b638b78c6d8195433146109fb576382b429006000526004601cfd5b638b78c6d819805473ffffffffffffffffffffffffffffffffffffffff9092169182907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0600080a355565b6000611083638b78c6d8195490565b73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16148061088e575073ffffffffffffffffffffffffffffffffffffffff8216301492915050565b6040805180820190915260008152606060208201526110f86040840184611e9d565b15905061123c5760008061110f6040860186611e9d565b81019061111c9190611f02565b91509150428265ffffffffffff16101561119b57604080517fcd0e140100000000000000000000000000000000000000000000000000000000815260ff60048201526024810191909152601760448201527f506c7567436f72653a736f6c7665722d657870697265640000000000000000006064820152608401610da1565b8373ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161461123957604080517fcd0e140100000000000000000000000000000000000000000000000000000000815260ff60048201526024810191909152601760448201527f506c7567436f72653a736f6c7665722d696e76616c69640000000000000000006064820152608401610da1565b50505b36600061124c6020860186611f2b565b9050905060005b818160ff1610156113b05761126b6020870187611f2b565b8260ff1681811061127e5761127e611dec565b90506020028101906112909190611f93565b925060006112a16020850185611ad9565b73ffffffffffffffffffffffffffffffffffffffff1660408501356112c96020870187611e9d565b6112d7916001908290611fc7565b6040516112e5929190611ff1565b60006040518083038185875af1925050503d8060008114611322576040519150601f19603f3d011682016040523d82523d6000602084013e611327565b606091505b505090508061139d57604080517fcd0e140100000000000000000000000000000000000000000000000000000000815260ff841660048201526024810191909152601460448201527f506c7567436f72653a706c75672d6661696c65640000000000000000000000006064820152608401610da1565b50806113a881612001565b915050611253565b505060408051808201825260ff8152815160208181019093526000815291810191909152949350505050565b60008061143c6113ef6020850185611e9d565b8080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152506108889250611433915087905080611e5f565b61025590612047565b9050600061144a8480611e5f565b611458906060810190611e9d565b61146191612053565b60a881901c60009081526002602052604090205460a09190911c915060ff82161c60011615156001036114f957604080517fcd0e140100000000000000000000000000000000000000000000000000000000815260ff60048201526024810191909152601660448201527f506c7567436f72653a6e6f6e63652d696e76616c6964000000000000000000006064820152608401610da1565b600881901c60009081526002602052604090208054600160ff84161b17905573ffffffffffffffffffffffffffffffffffffffff821660009081526001602052604090205460ff168061158357508173ffffffffffffffffffffffffffffffffffffffff1661156b638b78c6d8195490565b73ffffffffffffffffffffffffffffffffffffffff16145b949350505050565b60005b838110156115a657818101518382015260200161158e565b50506000910152565b600081518084526115c781602086016020860161158b565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169290920160200192915050565b60208152600061160c60208301846115af565b9392505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040516080810167ffffffffffffffff8111828210171561166557611665611613565b60405290565b604051601f82017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe016810167ffffffffffffffff811182821017156116b2576116b2611613565b604052919050565b73ffffffffffffffffffffffffffffffffffffffff81168114610ee957600080fd5b600082601f8301126116ed57600080fd5b813567ffffffffffffffff81111561170757611707611613565b61173860207fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f8401160161166b565b81815284602083860101111561174d57600080fd5b816020850160208301376000918101602001919091529392505050565b60006060828403121561177c57600080fd5b6040516060810167ffffffffffffffff82821081831117156117a0576117a0611613565b81604052829350843591506117b4826116ba565b908252602084013590808211156117ca57600080fd5b506117d7858286016116dc565b602083015250604083013560408201525092915050565b600082601f8301126117ff57600080fd5b8135602067ffffffffffffffff8083111561181c5761181c611613565b8260051b61182b83820161166b565b938452858101830193838101908886111561184557600080fd5b84880192505b85831015611881578235848111156118635760008081fd5b6118718a87838c010161176a565b835250918401919084019061184b565b98975050505050505050565b60006080828403121561189f57600080fd5b6118a7611642565b905081356118b4816116ba565b8152602082013567ffffffffffffffff808211156118d157600080fd5b6118dd858386016117ee565b602084015260408401359150808211156118f657600080fd5b611902858386016116dc565b6040840152606084013591508082111561191b57600080fd5b50611928848285016116dc565b60608301525092915050565b60006020828403121561194657600080fd5b813567ffffffffffffffff81111561195d57600080fd5b6115838482850161188d565b60006020828403121561197b57600080fd5b813567ffffffffffffffff8082111561199357600080fd5b90830190608082860312156119a757600080fd5b6119af611642565b8235828111156119be57600080fd5b6119ca878286016116dc565b8252506020830135828111156119df57600080fd5b6119eb878286016116dc565b6020830152506040830135604082015260608301359250611a0b836116ba565b6060810192909252509392505050565b60008060408385031215611a2e57600080fd5b8235611a39816116ba565b91506020830135611a49816116ba565b809150509250929050565b600080600060408486031215611a6957600080fd5b8335611a74816116ba565b9250602084013567ffffffffffffffff80821115611a9157600080fd5b818601915086601f830112611aa557600080fd5b813581811115611ab457600080fd5b876020828501011115611ac657600080fd5b6020830194508093505050509250925092565b600060208284031215611aeb57600080fd5b813561160c816116ba565b600060208284031215611b0857600080fd5b813567ffffffffffffffff80821115611b2057600080fd5b9083019060408286031215611b3457600080fd5b604051604081018181108382111715611b4f57611b4f611613565b604052823582811115611b6157600080fd5b611b6d8782860161188d565b825250602083013582811115611b8257600080fd5b611b8e878286016116dc565b60208301525095945050505050565b60008083601f840112611baf57600080fd5b50813567ffffffffffffffff811115611bc757600080fd5b6020830191508360208260051b8501011115611be257600080fd5b9250929050565b60008060008060408587031215611bff57600080fd5b843567ffffffffffffffff80821115611c1757600080fd5b611c2388838901611b9d565b90965094506020870135915080821115611c3c57600080fd5b50611c4987828801611b9d565b95989497509550505050565b600060208284031215611c6757600080fd5b813567ffffffffffffffff811115611c7e57600080fd5b6115838482850161176a565b600060208284031215611c9c57600080fd5b813567ffffffffffffffff811115611cb357600080fd5b611583848285016117ee565b602081526000825160806020840152611cdb60a08401826115af565b905060208401517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0848303016040850152611d1682826115af565b9150506040840151606084015273ffffffffffffffffffffffffffffffffffffffff60608501511660808401528091505092915050565b600060208284031215611d5f57600080fd5b813567ffffffffffffffff811115611d7657600080fd5b82016080818503121561160c57600080fd5b6020815260ff82511660208201526000602083015160408084015261158360608401826115af565b60008060408385031215611dc357600080fd5b823567ffffffffffffffff811115611dda57600080fd5b830160408186031215611a3957600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600060208284031215611e2d57600080fd5b8135801515811461160c57600080fd5b60008351611e4f81846020880161158b565b9190910191825250602001919050565b600082357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff81833603018112611e9357600080fd5b9190910192915050565b60008083357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe1843603018112611ed257600080fd5b83018035915067ffffffffffffffff821115611eed57600080fd5b602001915036819003821315611be257600080fd5b60008060408385031215611f1557600080fd5b823565ffffffffffff81168114611a3957600080fd5b60008083357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe1843603018112611f6057600080fd5b83018035915067ffffffffffffffff821115611f7b57600080fd5b6020019150600581901b3603821315611be257600080fd5b600082357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa1833603018112611e9357600080fd5b60008085851115611fd757600080fd5b83861115611fe457600080fd5b5050820193919092039150565b8183823760009101908152919050565b600060ff821660ff810361203e577f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60010192915050565b600061088e368361188d565b7fffffffffffffffffffffffff0000000000000000000000000000000000000000813581811691600c85101561209357808186600c0360031b1b83161692505b50509291505056fea164736f6c6343000817000a";

    bytes32 internal constant PLUG_SOCKET_SALT =
        0x00000000000000000000000000000000000000009c013ae72debff3f3af3dc63;

    address internal constant PLUG_SOCKET_ADDRESS = 0x002095a901152A1CBb15cD5C3e9701A86c75EE81;

    bytes internal constant PLUG_INITCODE =
        hex"6080604052600080546001600160a01b031916722ad07234d683525284287c2f921788a699d4a517905534801561003557600080fd5b506110c2806100456000396000f3fe60806040526004361061003f5760003560e01c806306fdde031461004457806311b283311461009c57806339a1cfd9146100bc57806395d89b41146100dc575b600080fd5b34801561005057600080fd5b5060408051808201909152600481527f506c75670000000000000000000000000000000000000000000000000000000060208201525b604051610093919061071c565b60405180910390f35b6100af6100aa36600461072f565b610122565b6040516100939190610794565b6100cf6100ca3660046107a7565b610147565b604051610093919061081c565b3480156100e857600080fd5b5060408051808201909152600481527f504c5547000000000000000000000000000000000000000000000000000000006020820152610086565b6040805180820190915260008152606060208201526101418233610225565b92915050565b6060818067ffffffffffffffff8111156101635761016361089e565b6040519080825280602002602001820160405280156101a957816020015b6040805180820190915260008152606060208201528152602001906001900390816101815790505b50915060005b818160ff16101561021d576101ea85858360ff168181106101d2576101d26108cd565b90506020028101906101e491906108fc565b33610225565b838260ff16815181106101ff576101ff6108cd565b6020026020010181905250808061021590610969565b9150506101af565b505092915050565b60408051808201909152600081526060602082015261024383610568565b73ffffffffffffffffffffffffffffffffffffffff1663dcfd71a484846040518363ffffffff1660e01b815260040161027d929190610b14565b6000604051808303816000875af19250505080156102bd57506040513d6000823e601f3d908101601f191682016040526102ba9190810190610d7d565b60015b610561576102c9610e11565b806308c379a00361031457506102dd610e2d565b806102e8575061037f565b6040518060400160405280600160ff6103019190610ed5565b60ff168152602001919091529050610141565b634e487b710361037f57610326610eee565b90610331575061037f565b6040518060400160405280600260ff61034a9190610ed5565b60ff1681526020018260405160200161036591815260200190565b604051602081830303815290604052815250915050610141565b3d8080156103a9576040519150601f19603f3d011682016040523d82523d6000602084013e6103ae565b606091505b5060048151101561041b576040518060400160405280600460ff6103d29190610ed5565b60ff1681526020016040518060400160405280600f81526020017f506c75673a656d7074792d646174610000000000000000000000000000000000815250815250915050610141565b7fcd0e14010000000000000000000000000000000000000000000000000000000061044582610f0e565b7fffffffff0000000000000000000000000000000000000000000000000000000016146104ce576040518060400160405280600360ff6104859190610ed5565b60ff1681526020016040518060400160405280601581526020017f506c75673a756e6b6e6f776e2d73656c6563746f720000000000000000000000815250815250915050610141565b60405181517ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc01808252602483016020830160005b8381101561051b578281015182820152602001610503565b505050806020018201604052506000808280602001905181019061053f9190610f5e565b6040805180820190915260ff9092168252602082015294506101419350505050565b9392505050565b6000806105758380610fac565b610583906020810190610fe0565b90508073ffffffffffffffffffffffffffffffffffffffff163b600003610141576000805473ffffffffffffffffffffffffffffffffffffffff16627743606105cc8680610fac565b6105da906060810190610ffd565b6040518363ffffffff1660e01b81526004016105f7929190611062565b60408051808303816000875af1158015610615573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106399190611076565b9150508073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16146106c5576040517f5a4be8f400000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff80841660048301528216602482015260440160405180910390fd5b5092915050565b60005b838110156106e75781810151838201526020016106cf565b50506000910152565b600081518084526107088160208601602086016106cc565b601f01601f19169290920160200192915050565b60208152600061056160208301846106f0565b60006020828403121561074157600080fd5b813567ffffffffffffffff81111561075857600080fd5b82016040818503121561056157600080fd5b60ff8151168252600060208201516040602085015261078c60408501826106f0565b949350505050565b602081526000610561602083018461076a565b600080602083850312156107ba57600080fd5b823567ffffffffffffffff808211156107d257600080fd5b818501915085601f8301126107e657600080fd5b8135818111156107f557600080fd5b8660208260051b850101111561080a57600080fd5b60209290920196919550909350505050565b600060208083016020845280855180835260408601915060408160051b87010192506020870160005b82811015610891577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc088860301845261087f85835161076a565b94509285019290850190600101610845565b5092979650505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600082357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc183360301811261093057600080fd5b9190910192915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600060ff821660ff810361097f5761097f61093a565b60010192915050565b73ffffffffffffffffffffffffffffffffffffffff811681146109aa57600080fd5b50565b60008083357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe18436030181126109e257600080fd5b830160208101925035905067ffffffffffffffff811115610a0257600080fd5b803603821315610a1157600080fd5b9250929050565b818352818160208501375060006020828401015260006020601f19601f840116840101905092915050565b60008383855260208086019550808560051b830101846000805b88811015610b0657601f19868503018a5282357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa1893603018112610a9f578283fd5b880160608135610aae81610988565b73ffffffffffffffffffffffffffffffffffffffff168652610ad2828801836109ad565b8289890152610ae48389018284610a18565b6040948501359890940197909752505099850199935091840191600101610a5d565b509198975050505050505050565b60408152600083357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff81853603018112610b4c57600080fd5b60408381015284018035610b5f81610988565b73ffffffffffffffffffffffffffffffffffffffff1660808401526020810135368290037fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe1018112610bb057600080fd5b810160208101903567ffffffffffffffff811115610bcd57600080fd5b8060051b3603821315610bdf57600080fd5b608060a0860152610bf561010086018284610a43565b915050610c0560408301836109ad565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff80808785030160c0880152610c3b848385610a18565b9350610c4a60608601866109ad565b95509250808785030160e08801525050610c65828483610a18565b92505050610c7660208601866109ad565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc0858403016060860152610cab838284610a18565b9350505050610561602083018473ffffffffffffffffffffffffffffffffffffffff169052565b601f19601f830116810181811067ffffffffffffffff82111715610cf857610cf861089e565b6040525050565b805160ff81168114610d1057600080fd5b919050565b600082601f830112610d2657600080fd5b815167ffffffffffffffff811115610d4057610d4061089e565b604051610d576020601f19601f8501160182610cd2565b818152846020838601011115610d6c57600080fd5b61078c8260208301602087016106cc565b600060208284031215610d8f57600080fd5b815167ffffffffffffffff80821115610da757600080fd5b9083019060408286031215610dbb57600080fd5b604051604081018181108382111715610dd657610dd661089e565b604052610de283610cff565b8152602083015182811115610df657600080fd5b610e0287828601610d15565b60208301525095945050505050565b600060033d1115610e2a5760046000803e5060005160e01c5b90565b600060443d1015610e3b5790565b6040517ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc803d016004833e81513d67ffffffffffffffff8160248401118184111715610e8957505050505090565b8285019150815181811115610ea15750505050505090565b843d8701016020828501011115610ebb5750505050505090565b610eca60208286010187610cd2565b509095945050505050565b60ff82811682821603908111156101415761014161093a565b60008060233d1115610f0a576020600460003e50506000516001905b9091565b6000815160208301517fffffffff0000000000000000000000000000000000000000000000000000000080821693506004831015610f565780818460040360031b1b83161693505b505050919050565b60008060408385031215610f7157600080fd5b610f7a83610cff565b9150602083015167ffffffffffffffff811115610f9657600080fd5b610fa285828601610d15565b9150509250929050565b600082357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8183360301811261093057600080fd5b600060208284031215610ff257600080fd5b813561056181610988565b60008083357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe184360301811261103257600080fd5b83018035915067ffffffffffffffff82111561104d57600080fd5b602001915036819003821315610a1157600080fd5b60208152600061078c602083018486610a18565b6000806040838503121561108957600080fd5b8251801515811461109957600080fd5b60208401519092506110aa81610988565b80915050925092905056fea164736f6c6343000817000a";

    bytes32 internal constant PLUG_SALT =
        0x00000000000000000000000000000000000000005ab395c4b7feff3f014c7022;

    address internal constant PLUG_ADDRESS = 0x00039b071d5a706C3684fFC13a882ddf53Bc1Ff2;

    /**
     * @notice Deploy (if needed) and return the PlugFactory contract instance.
     * @return $plugFactory The PlugFactory contract instance.
     */
    function plugFactory() internal returns (PlugFactory $plugFactory) {
        require(
            keccak256(abi.encodePacked(type(PlugFactory).creationCode))
                == keccak256(abi.encodePacked(PLUG_FACTORY_INITCODE)),
            "PlugEtcherLib:invalid-initcode"
        );

        if (_extcodesize(PLUG_FACTORY_ADDRESS) == 0) {
            address reality = safeCreate2(PLUG_FACTORY_SALT, PLUG_FACTORY_INITCODE);
            require(reality == PLUG_FACTORY_ADDRESS, "PlugEtcherLib:unexpected-address");
        }

        $plugFactory = PlugFactory(payable(PLUG_FACTORY_ADDRESS));
    }

    /**
     * @notice Deploy (if needed) and return the PlugSocket contract instance.
     * @return $plugSocket The PlugSocket contract instance.
     */
    function plugSocket() internal returns (PlugSocket $plugSocket) {
        require(
            keccak256(abi.encodePacked(type(PlugSocket).creationCode))
                == keccak256(abi.encodePacked(PLUG_SOCKET_INITCODE)),
            "PlugEtcherLib:invalid-initcode"
        );

        if (_extcodesize(PLUG_SOCKET_ADDRESS) == 0) {
            address reality = safeCreate2(PLUG_SOCKET_SALT, PLUG_SOCKET_INITCODE);
            require(reality == PLUG_SOCKET_ADDRESS, "PlugEtcherLib:unexpected-address");
        }

        $plugSocket = PlugSocket(payable(PLUG_SOCKET_ADDRESS));
    }

    /**
     * @notice Deploy (if needed) and return the Plug contract instance.
     * @return $plug The Plug contract instance.
     */
    function plug() internal returns (Plug $plug) {
        require(
            keccak256(abi.encodePacked(type(Plug).creationCode))
                == keccak256(abi.encodePacked(PLUG_INITCODE)),
            "PlugEtcherLib:invalid-initcode"
        );

        if (_extcodesize(PLUG_ADDRESS) == 0) {
            address reality = safeCreate2(PLUG_SALT, PLUG_INITCODE);
            require(reality == PLUG_ADDRESS, "PlugEtcherLib:unexpected-address");
        }

        $plug = Plug(payable(PLUG_ADDRESS));
    }

    /**
     * @notice Deploys a contract via 0age's immutable create 2 factory for testing.
     * @param $salt The salt to use for the deployment.
     * @param $initializationCode The initialization code for the contract.
     * @return $deployment The address of the deployed contract.
     */
    function safeCreate2(
        bytes32 $salt,
        bytes memory $initializationCode
    )
        public
        returns (address $deployment)
    {
        // Canonical address of 0age's immutable create 2 factory.
        address c2f = 0x0000000000FFe8B47B3e2130213B802212439497;
        if (_extcodesize(c2f) == 0) {
            bytes memory ic2fBytecode =
                hex"60806040526004361061003f5760003560e01c806308508b8f1461004457806364e030871461009857806385cf97ab14610138578063a49a7c90146101bc575b600080fd5b34801561005057600080fd5b506100846004803603602081101561006757600080fd5b503573ffffffffffffffffffffffffffffffffffffffff166101ec565b604080519115158252519081900360200190f35b61010f600480360360408110156100ae57600080fd5b813591908101906040810160208201356401000000008111156100d057600080fd5b8201836020820111156100e257600080fd5b8035906020019184600183028401116401000000008311171561010457600080fd5b509092509050610217565b6040805173ffffffffffffffffffffffffffffffffffffffff9092168252519081900360200190f35b34801561014457600080fd5b5061010f6004803603604081101561015b57600080fd5b8135919081019060408101602082013564010000000081111561017d57600080fd5b82018360208201111561018f57600080fd5b803590602001918460018302840111640100000000831117156101b157600080fd5b509092509050610592565b3480156101c857600080fd5b5061010f600480360360408110156101df57600080fd5b508035906020013561069e565b73ffffffffffffffffffffffffffffffffffffffff1660009081526020819052604090205460ff1690565b600083606081901c33148061024c57507fffffffffffffffffffffffffffffffffffffffff0000000000000000000000008116155b6102a1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260458152602001806107746045913960600191505060405180910390fd5b606084848080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920182905250604051855195965090943094508b93508692506020918201918291908401908083835b6020831061033557805182527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe090920191602091820191016102f8565b51815160209384036101000a7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff018019909216911617905260408051929094018281037fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe00183528085528251928201929092207fff000000000000000000000000000000000000000000000000000000000000008383015260609890981b7fffffffffffffffffffffffffffffffffffffffff00000000000000000000000016602183015260358201969096526055808201979097528251808203909701875260750182525084519484019490942073ffffffffffffffffffffffffffffffffffffffff81166000908152938490529390922054929350505060ff16156104a7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252603f815260200180610735603f913960400191505060405180910390fd5b81602001825188818334f5955050508073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff161461053a576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260468152602001806107b96046913960600191505060405180910390fd5b50505073ffffffffffffffffffffffffffffffffffffffff8116600090815260208190526040902080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff001660011790559392505050565b6000308484846040516020018083838082843760408051919093018181037fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe001825280845281516020928301207fff000000000000000000000000000000000000000000000000000000000000008383015260609990991b7fffffffffffffffffffffffffffffffffffffffff000000000000000000000000166021820152603581019790975260558088019890985282518088039098018852607590960182525085519585019590952073ffffffffffffffffffffffffffffffffffffffff81166000908152948590529490932054939450505060ff909116159050610697575060005b9392505050565b604080517fff000000000000000000000000000000000000000000000000000000000000006020808301919091523060601b6021830152603582018590526055808301859052835180840390910181526075909201835281519181019190912073ffffffffffffffffffffffffffffffffffffffff81166000908152918290529190205460ff161561072e575060005b9291505056fe496e76616c696420636f6e7472616374206372656174696f6e202d20636f6e74726163742068617320616c7265616479206265656e206465706c6f7965642e496e76616c69642073616c74202d206669727374203230206279746573206f66207468652073616c74206d757374206d617463682063616c6c696e6720616464726573732e4661696c656420746f206465706c6f7920636f6e7472616374207573696e672070726f76696465642073616c7420616e6420696e697469616c697a6174696f6e20636f64652ea265627a7a723058202bdc55310d97c4088f18acf04253db593f0914059f0c781a9df3624dcef0d1cf64736f6c634300050a0032";
            /// @solidity memory-safe-assembly
            assembly {
                let m := mload(0x40)
                mstore(m, 0xb4d6c782) // `etch(address,bytes)`.
                mstore(add(m, 0x20), c2f)
                mstore(add(m, 0x40), 0x40)
                let n := mload(ic2fBytecode)
                mstore(add(m, 0x60), n)
                for { let i := 0 } lt(i, n) { i := add(0x20, i) } {
                    mstore(add(add(m, 0x80), i), mload(add(add(ic2fBytecode, 0x20), i)))
                }
                let vmAddress := 0x7109709ECfa91a80626fF3989D68f67F5b1DD12D
                if iszero(call(gas(), vmAddress, 0, add(m, 0x1c), add(n, 0x64), 0x00, 0x00)) {
                    revert(0, 0)
                }
            }
        }
        /// @solidity memory-safe-assembly
        assembly {
            let m := mload(0x40)
            let n := mload($initializationCode)
            mstore(m, 0x64e03087) // `safeCreate2(bytes32,bytes)`.
            mstore(add(m, 0x20), $salt)
            mstore(add(m, 0x40), 0x40)
            mstore(add(m, 0x60), n)
            // prettier-ignore
            for { let i := 0 } lt(i, n) { i := add(i, 0x20) } {
                mstore(add(add(m, 0x80), i), mload(add(add($initializationCode, 0x20), i)))
            }
            if iszero(call(gas(), c2f, 0, add(m, 0x1c), add(n, 0x64), m, 0x20)) {
                returndatacopy(m, m, returndatasize())
                revert(m, returndatasize())
            }
            $deployment := mload(m)
        }
    }

    /**
     * @notice Determine and retrieve the extcodesize of `deployment`.
     * @param $deployment The address to check.
     * @return $result The size of the code at `deployment`.
     */
    function _extcodesize(address $deployment) private view returns (uint256 $result) {
        /// @solidity memory-safe-assembly
        assembly {
            $result := extcodesize($deployment)
        }
    }
}
