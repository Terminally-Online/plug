// SPDX-License-Identifier: MIT

pragma solidity 0.8.23;

import { PlugLib } from "../libraries/Plug.Lib.sol";
import { PlugFactory } from "../base/Plug.Factory.sol";
import { PlugSocket } from "../base/Plug.Socket.sol";
import { Plug } from "../base/Plug.sol";

interface ImmutableCreate2Factory {
    function safeCreate2(
        bytes32 salt,
        bytes calldata initCode
    )
        external
        payable
        returns (address deploymentAddress);

    function findCreate2Address(
        bytes32 salt,
        bytes calldata initCode
    )
        external
        view
        returns (address deploymentAddress);

    function findCreate2AddressViaHash(
        bytes32 salt,
        bytes32 initCodeHash
    )
        external
        view
        returns (address deploymentAddress);
}

/**
 * @title Plug Etcher
 * @notice This contract is the basis of the automatically generated Plug Etcher
 *         contract used to deploy and write the proper addresses. If you need to add
 *         a new etch into the vm stack for testing, you will do so through the file
 *         found at: /lib/functions/etcher.ts
 * @notice A good portion of this model comes from:
 *         https://github.com/Vectorized/multicaller/blob/main/src/MulticallerEtcher.sol
 *         I am not a Foundry expert. If there is a better way to do this, please let me
 *         know because this is a lot of work just to get a contract deployed when you're
 *         doing anything more than a simple in-and-out contract.
 * @author vectorized (twitter:@optimizoor)
 */
library PlugEtcherLib {
    /// @notice The immutable Create2 factory used for deployment.
    ImmutableCreate2Factory internal constant FACTORY =
        ImmutableCreate2Factory(0x0000000000FFe8B47B3e2130213B802212439497);

    bytes internal constant PLUG_FACTORY_INITCODE =
        hex"608060405234801561001057600080fd5b506106db806100206000396000f3fe6080604052600436106100335760003560e01c80627743601461003857806375fd9f281461007c5780637ac4ed641461011a575b600080fd5b61004b6100463660046105a9565b61015f565b60408051921515835273ffffffffffffffffffffffffffffffffffffffff9091166020830152015b60405180910390f35b34801561008857600080fd5b5061010c610097366004610644565b604080517fcc3735a920a3ca505d382bbc545af43d6000803e6038573d6000fd5b3d6000f360609081527f5155f3363d3d373d3d363d7f360894a13ba1a3210667c828492db98dca3e20768352616009602052601e9390935268603d3d8160223d3973600a52605f6021209152600090915290565b604051908152602001610073565b34801561012657600080fd5b5061013a61013536600461065f565b6103fd565b60405173ffffffffffffffffffffffffffffffffffffffff9091168152602001610073565b60008060808310156101d2576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601760248201527f506c7567436f72653a73616c742d6d616c666f726d656400000000000000000060448201526064015b60405180910390fd5b833560208501356040860135606087013573ffffffffffffffffffffffffffffffffffffffff8116158061021a575073ffffffffffffffffffffffffffffffffffffffff8316155b15610271576040517f54f044c400000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff8083166004830152841660248201526044016101c9565b604080517fffffffffffffffffffffffff000000000000000000000000000000000000000060a087901b1660208201527fffffffffffffffffffffffffffffffffffffffff000000000000000000000000606086901b16602c820152600091016040516020818303038152906040526102e990610689565b90506102f6348383610411565b9097509550866103f1578373ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167f32c7564be3bbeabe66360c08d019367b0d744fcb948046d92552c00c9743dd108360405161035f91815260200190565b60405180910390a36040517f485cc95500000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff8581166004830152848116602483015287169063485cc95590604401600060405180830381600087803b1580156103d857600080fd5b505af11580156103ec573d6000803e3d6000fd5b505050505b50505050509250929050565b600061040a8383306104f5565b9392505050565b6000806040517fcc3735a920a3ca505d382bbc545af43d6000803e6038573d6000fd5b3d6000f36060527f5155f3363d3d373d3d363d7f360894a13ba1a3210667c828492db98dca3e207660405261600960205284601e5268603d3d8160223d3973600a52605f60212060358201523060581b815260ff8153836015820152605581209150813b6104bd5783605f602188f59150816104b85763301164256000526004601cfd5b6104e3565b6001925085156104e35760003860003889865af16104e35763b12d13eb6000526004601cfd5b80604052506000606052935093915050565b60008061057185604080517fcc3735a920a3ca505d382bbc545af43d6000803e6038573d6000fd5b3d6000f360609081527f5155f3363d3d373d3d363d7f360894a13ba1a3210667c828492db98dca3e20768352616009602052601e9390935268603d3d8160223d3973600a52605f6021209152600090915290565b905061057e818585610587565b95945050505050565b600060ff60005350603592835260601b60015260155260556000908120915290565b600080602083850312156105bc57600080fd5b823567ffffffffffffffff808211156105d457600080fd5b818501915085601f8301126105e857600080fd5b8135818111156105f757600080fd5b86602082850101111561060957600080fd5b60209290920196919550909350505050565b803573ffffffffffffffffffffffffffffffffffffffff8116811461063f57600080fd5b919050565b60006020828403121561065657600080fd5b61040a8261061b565b6000806040838503121561067257600080fd5b61067b8361061b565b946020939093013593505050565b805160208083015191908110156106c8577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8160200360031b1b821691505b5091905056fea164736f6c6343000817000a";

    bytes32 internal constant PLUG_FACTORY_SALT =
        0x000000000000000000000000000000000000000061c1000389a9252cac99c238;

    address internal constant PLUG_FACTORY_ADDRESS = 0x0000000023EED31B68094b96810B68546A29A1Cd;

    bytes internal constant PLUG_SOCKET_INITCODE =
        hex"60a0604052306080523480156200001557600080fd5b506200002360018062000029565b620000a8565b62000034826200006c565b6001600160a01b0381161562000068576001600160a01b0381166000908152600260205260409020805460ff191660011790555b5050565b6001600160a01b0316638b78c6d8198190558060007f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08180a350565b6080516128d3620000cb6000396000818161115b015261119201526128d36000f3fe6080604052600436106101c65760003560e01c806360cd27ad116100f7578063b51f81f611610095578063e75e0ad611610064578063e75e0ad614610550578063f04e283e14610570578063f2fde38b14610583578063fee81cf414610596576101cd565b8063b51f81f6146104d8578063c2fb26a6146104f8578063dfe86ac51461051a578063e450bc5114610530576101cd565b80638da5cb5b116100d15780638da5cb5b1461047757806395d89b4114610490578063af433c7c146104a5578063b2f65adb146104b8576101cd565b806360cd27ad1461040f5780636f69f3d61461044f578063715018a61461046f576101cd565b806334bb37001161016457806352d1902d1161013e57806352d1902d1461038c57806353f022b4146103a157806354d1f13d146103c157806354fd4d50146103c9576101cd565b806334bb370014610339578063485cc955146103595780634f1ef28614610379576101cd565b8063161937ea116101a0578063161937ea146102aa57806317943105146102ca578063190dc9ac146102ea578063256929621461032f576101cd565b806306d2d4601461020857806306fdde031461023b5780630b21e86f1461028a576101cd565b366101cd57005b60003560e01c63bc197c81811463f23a6e6182141763150b7a02821417156101f957806020526020603cf35b50633c10b94e6000526004601cfd5b34801561021457600080fd5b50610228610223366004611f37565b6105cb565b6040519081526020015b60405180910390f35b34801561024757600080fd5b5060408051808201909152600b81527f506c756720536f636b657400000000000000000000000000000000000000000060208201525b6040516102329190611fbc565b34801561029657600080fd5b506102286102a5366004611fcf565b61067e565b3480156102b657600080fd5b506102286102c5366004612004565b6106f3565b3480156102d657600080fd5b506102286102e5366004612145565b61074c565b3480156102f657600080fd5b5061030a61030536600461217a565b610797565b60405173ffffffffffffffffffffffffffffffffffffffff9091168152602001610232565b6103376107ba565b005b34801561034557600080fd5b5061022861035436600461220b565b61080a565b34801561036557600080fd5b506103376103743660046122b7565b610890565b6103376103873660046122ea565b610908565b34801561039857600080fd5b506102286109c1565b6103b46103af36600461236d565b6109f0565b60405161023291906123a8565b610337610acf565b3480156103d557600080fd5b5060408051808201909152600581527f302e302e31000000000000000000000000000000000000000000000000000000602082015261027d565b34801561041b57600080fd5b5061043f61042a3660046123d0565b60026020526000908152604090205460ff1681565b6040519015158152602001610232565b34801561045b57600080fd5b5061033761046a366004612437565b610b0b565b610337610bd2565b34801561048357600080fd5b50638b78c6d8195461030a565b34801561049c57600080fd5b5061027d610be4565b6103b46104b33660046124a3565b610c9e565b3480156104c457600080fd5b506102286104d33660046124df565b610d83565b3480156104e457600080fd5b506102286104f336600461217a565b610dd7565b34801561050457600080fd5b5061050d610e33565b60405161023291906124fb565b34801561052657600080fd5b5061022860005481565b34801561053c57600080fd5b5061022861054b36600461256b565b610f03565b34801561055c57600080fd5b5061022861056b366004612145565b610f68565b61033761057e3660046123d0565b610ffd565b6103376105913660046123d0565b61103d565b3480156105a257600080fd5b506102286105b13660046123d0565b63389a75e1600c908152600091909152602090205490565b565b60007f77f9edb2051551cf1c4102bcde8eba61d391a9e0536544fe44cc2330cc4913fa60001b826000015183602001518460400151805190602001208560600151610619876080015161067e565b60408051602081019790975260ff9095169486019490945273ffffffffffffffffffffffffffffffffffffffff9092166060850152608084015260a083015260c082015260e0015b604051602081830303815290604052805190602001209050919050565b60006060600080845190505b808210156106e357826106b58684815181106106a8576106a86125a0565b6020026020010151610d83565b6040516020016106c69291906125cf565b60408051601f19818403018152919052925060019091019061068a565b5050805160209091012092915050565b805160208083015160408085015181517f705d2fbc03b585d2178271bc5e779f63e494ae79418e11352a00b51e1edeeaae9481019490945260ff909416908301526060820152608081019190915260009060a001610661565b6000805461075983610f68565b6040517f1901000000000000000000000000000000000000000000000000000000000000602082015260228101929092526042820152606201610661565b60006107b482602001516107ae846000015161074c565b90611064565b92915050565b60006202a30067ffffffffffffffff164201905063389a75e1600c5233600052806020600c2055337fdbf36a107da19e49527a7176a1babf963b4b0ff8cde35ee35d6cd8f1f9ac7e1d600080a250565b805180516020918201208183015180519083012060408085015160608087015183517f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f978101979097529286019490945292840191909152608083019190915273ffffffffffffffffffffffffffffffffffffffff1660a082015260009060c001610661565b6108998261110f565b73ffffffffffffffffffffffffffffffffffffffff8116156109045773ffffffffffffffffffffffffffffffffffffffff8116600090815260026020526040902080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff001660011790555b5050565b610910611158565b61091983611187565b8260601b60601c92503d6000526352d1902d6001527f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc80602060016004601d885afa511461096f576355299b496001526004601dfd5b837fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b600038a283905580156109bc57604051818382376000388383875af46109ba573d6000823e3d81fd5b505b505050565b60006109cb61118f565b507f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc90565b6040805180820190915260008152606060208201523068929eee149b4bd212685403610a245763ab143c066000526004601cfd5b3068929eee149b4bd2126855610a39336111be565b1515600003610ab257604080517fcd0e140100000000000000000000000000000000000000000000000000000000815260ff60048201526024810191909152601760448201527f506c7567436f72653a73656e6465722d696e76616c696400000000000000000060648201526084015b60405180910390fd5b610abd826000611220565b3868929eee149b4bd212685592915050565b63389a75e1600c523360005260006020600c2055337ffa7b8eab7da67f412cc9575ed43464468f9bfbae89d1675917346ca6d8fe3c92600080a2565b610b13611908565b60005b83811015610bcb57828282818110610b3057610b306125a0565b9050602002016020810190610b4591906125f1565b60026000878785818110610b5b57610b5b6125a0565b9050602002016020810190610b7091906123d0565b73ffffffffffffffffffffffffffffffffffffffff168152602081019190915260400160002080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0016911515919091179055600101610b16565b5050505050565b610bda611908565b6105c96000611923565b60606000610c2260408051808201909152600b81527f506c756720536f636b6574000000000000000000000000000000000000000000602082015290565b9050805160405181815260208301602082016000805b85811015610c6a578084015160001a605b8110604082111615610c615780838501536001830192505b50600101610c38565b506005811115610c78575060055b80610c89575064504c554753815260045b80845283016020016040525090949350505050565b6040805180820190915260008152606060208201523068929eee149b4bd212685403610cd25763ab143c066000526004601cfd5b3068929eee149b4bd212685582610ce88161196e565b1515600003610d5c57604080517fcd0e140100000000000000000000000000000000000000000000000000000000815260ff60048201526024810191909152601a60448201527f506c7567436f72653a7369676e61747572652d696e76616c69640000000000006064820152608401610aa9565b610d6f610d698580612613565b84611220565b3868929eee149b4bd2126855949350505050565b805160208201516000917f56b7ba00148b10c99ae43c2f84a4ec0ec1dfa2e5d7d5954f23e627d964b8343591610db8906106f3565b6040805160208101949094528301919091526060820152608001610661565b80516000907fb17d5f6d50f15d707601c6994c8e42d3c170be70fe81f012884129e8e5bf41ff90610e0790610f68565b602080850151805190820120604051610661949392019283526020830191909152604082015260600190565b610e746040518060800160405280606081526020016060815260200160008152602001600073ffffffffffffffffffffffffffffffffffffffff1681525090565b6040805160c08101909152600b608082019081527f506c756720536f636b657400000000000000000000000000000000000000000060a083015281908152602001610eef60408051808201909152600581527f302e302e31000000000000000000000000000000000000000000000000000000602082015290565b815246602082015230604090910152919050565b60006060600080845190505b808210156106e35782610f3a868481518110610f2d57610f2d6125a0565b60200260200101516105cb565b604051602001610f4b9291906125cf565b60408051601f198184030181529190529250600190910190610f0f565b805160208201516000917ff730b3caf995a40c1030675beebec0f819730393c3020ff6bd0295c733af216b91610f9d90610f03565b84604001518051906020012085606001518051906020012060405160200161066195949392919094855273ffffffffffffffffffffffffffffffffffffffff93909316602085015260408401919091526060830152608082015260a00190565b611005611908565b63389a75e1600c52806000526020600c20805442111561102d57636f5e88186000526004601cfd5b6000905561103a81611923565b50565b611045611908565b8060601b61105b57637448fbae6000526004601cfd5b61103a81611923565b600060405182516040811461108157604181146110bb57506110fa565b604084015160ff81901c601b016020527f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff166060526110cf565b606084015160001a60205260408401516060525b50836000526020830151604052602060016080600060015afa5191506000606052806040523d611108575b638baa579f6000526004601cfd5b5092915050565b73ffffffffffffffffffffffffffffffffffffffff16638b78c6d8198190558060007f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08180a350565b307f0000000000000000000000000000000000000000000000000000000000000000036105c9576105c9611b25565b61103a611908565b307f0000000000000000000000000000000000000000000000000000000000000000146105c9576105c9611b25565b60006111cd638b78c6d8195490565b73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1614806107b4575073ffffffffffffffffffffffffffffffffffffffff8216301492915050565b6040805180820190915260008152606060208201526112426040840184612651565b15905061140657604061125784820185612651565b905010156112ca57604080517fcd0e140100000000000000000000000000000000000000000000000000000000815260ff60048201526024810191909152601960448201527f506c7567436f72653a736f6c7665722d6d616c666f726d6564000000000000006064820152608401610aa9565b426112e06112db6040860186612651565b503590565b101561135157604080517fcd0e140100000000000000000000000000000000000000000000000000000000815260ff60048201526024810191909152601760448201527f506c7567436f72653a736f6c7665722d657870697265640000000000000000006064820152608401610aa9565b73ffffffffffffffffffffffffffffffffffffffff82166113806113786040860186612651565b506020013590565b73ffffffffffffffffffffffffffffffffffffffff161461140657604080517fcd0e140100000000000000000000000000000000000000000000000000000000815260ff60048201526024810191909152601760448201527f506c7567436f72653a736f6c7665722d696e76616c69640000000000000000006064820152608401610aa9565b600061141560208501856126b6565b905090503660606000808467ffffffffffffffff81111561143857611438611bf6565b60405190808252806020026020018201604052801561146b57816020015b60608152602001906001900390816114565790505b50905060008060608060005b898160ff1610156118d55761148f60208e018e6126b6565b8260ff168181106114a2576114a26125a0565b90506020028101906114b4919061271e565b98506114c360408a018a612651565b6114d1916001908290612752565b8080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929a506115169250505060808a018a61277c565b600096509450505b838560ff1610156116e8573661153760808b018b61277c565b8760ff1681811061154a5761154a6125a0565b60800291909101915050602081018761156660408401836127e4565b60ff1681518110611579576115796125a0565b60200260200101519450845181604001358260200135611599919061282e565b1115611601576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601660248201527f506c7567436f72653a6f75742d6f662d626f756e6473000000000000000000006044820152606401610aa9565b61161d85602083013561161860408501358261282e565b611b33565b8a519094506116316040830135843561282e565b1115611699576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601760248201527f506c7567436f72653a776f756c642d6f766572666c6f770000000000000000006044820152606401610aa9565b6116d16116b26116ac8c60008635611b33565b86611b9a565b6116cc8c6116c56040860135873561282e565b8e51611b33565b611b9a565b9950505084806116e090612841565b95505061151e565b6116f560208a018a6127e4565b60ff166000036117a25761170f60408a0160208b016123d0565b73ffffffffffffffffffffffffffffffffffffffff168960600135896040516117389190612860565b60006040518083038185875af1925050503d8060008114611775576040519150601f19603f3d011682016040523d82523d6000602084013e61177a565b606091505b50878360ff1681518110611790576117906125a0565b60209081029190910101529650611851565b6117af60208a018a6127e4565b60ff16600103611851576117c960408a0160208b016123d0565b73ffffffffffffffffffffffffffffffffffffffff16886040516117ed9190612860565b600060405180830381855af49150503d8060008114611828576040519150601f19603f3d011682016040523d82523d6000602084013e61182d565b606091505b50878360ff1681518110611843576118436125a0565b602090810291909101015296505b866118c357604080517fcd0e140100000000000000000000000000000000000000000000000000000000815260ff831660048201526024810191909152601460448201527f506c7567436f72653a706c75672d6661696c65640000000000000000000000006064820152608401610aa9565b806118cd81612841565b915050611477565b505060408051808201825260ff81528151602081810190935260008152918101919091529b9a5050505050505050505050565b638b78c6d8195433146105c9576382b429006000526004601cfd5b638b78c6d819805473ffffffffffffffffffffffffffffffffffffffff9092169182907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0600080a355565b6000806119ce6119816020850185612651565b8080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152506107ae92506119c5915087905080612613565b6102e590612872565b905060006119dc8480612613565b6119ea906060810190612651565b6119f39161287e565b60a01c9050611a20600182600881901c6000908152602092909252604090912054600160ff9092161c1690565b1515600103611a9457604080517fcd0e140100000000000000000000000000000000000000000000000000000000815260ff60048201526024810191909152601660448201527f506c7567436f72653a6e6f6e63652d696e76616c6964000000000000000000006064820152608401610aa9565b600881901c6000908152600160208181526040808420805460ff8088169590951b17905573ffffffffffffffffffffffffffffffffffffffff861684526002909152909120541680611b1d57508173ffffffffffffffffffffffffffffffffffffffff16611b05638b78c6d8195490565b73ffffffffffffffffffffffffffffffffffffffff16145b949350505050565b639f03a0266000526004601cfd5b60608351828111611b42578092505b838111611b4d578093505b5081831015611b935750604051828203848401601f19601f830181165b8281015185820152810180611b6a57505050806020830101600081526020810160405250808252505b9392505050565b6040518251601f19906020810182165b8581015184820152820180611baa575083518184018360208301165b8681015182820152840180611bc65750506000910183810160208101929092528352604090810190525092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040805190810167ffffffffffffffff81118282101715611c4857611c48611bf6565b60405290565b6040516080810167ffffffffffffffff81118282101715611c4857611c48611bf6565b604051601f8201601f1916810167ffffffffffffffff81118282101715611c9a57611c9a611bf6565b604052919050565b803560ff81168114611cb357600080fd5b919050565b803573ffffffffffffffffffffffffffffffffffffffff81168114611cb357600080fd5b600082601f830112611ced57600080fd5b813567ffffffffffffffff811115611d0757611d07611bf6565b611d1a6020601f19601f84011601611c71565b818152846020838601011115611d2f57600080fd5b816020850160208301376000918101602001919091529392505050565b600067ffffffffffffffff821115611d6657611d66611bf6565b5060051b60200190565b600060608284031215611d8257600080fd5b6040516060810181811067ffffffffffffffff82111715611da557611da5611bf6565b604052905080611db483611ca2565b815260208301356020820152604083013560408201525092915050565b600060808284031215611de357600080fd5b611deb611c25565b905081358152611dfe8360208401611d70565b602082015292915050565b600082601f830112611e1a57600080fd5b81356020611e2f611e2a83611d4c565b611c71565b8083825260208201915060208460071b870101935086841115611e5157600080fd5b602086015b84811015611e7657611e688882611dd1565b835291830191608001611e56565b509695505050505050565b600060a08284031215611e9357600080fd5b60405160a0810167ffffffffffffffff8282108183111715611eb757611eb7611bf6565b81604052829350611ec785611ca2565b8352611ed560208601611cb8565b60208401526040850135915080821115611eee57600080fd5b611efa86838701611cdc565b6040840152606085013560608401526080850135915080821115611f1d57600080fd5b50611f2a85828601611e09565b6080830152505092915050565b600060208284031215611f4957600080fd5b813567ffffffffffffffff811115611f6057600080fd5b611b1d84828501611e81565b60005b83811015611f87578181015183820152602001611f6f565b50506000910152565b60008151808452611fa8816020860160208601611f6c565b601f01601f19169290920160200192915050565b602081526000611b936020830184611f90565b600060208284031215611fe157600080fd5b813567ffffffffffffffff811115611ff857600080fd5b611b1d84828501611e09565b60006060828403121561201657600080fd5b611b938383611d70565b600082601f83011261203157600080fd5b81356020612041611e2a83611d4c565b82815260059290921b8401810191818101908684111561206057600080fd5b8286015b84811015611e7657803567ffffffffffffffff8111156120845760008081fd5b6120928986838b0101611e81565b845250918301918301612064565b6000608082840312156120b257600080fd5b6120ba611c4e565b90506120c582611cb8565b8152602082013567ffffffffffffffff808211156120e257600080fd5b6120ee85838601612020565b6020840152604084013591508082111561210757600080fd5b61211385838601611cdc565b6040840152606084013591508082111561212c57600080fd5b5061213984828501611cdc565b60608301525092915050565b60006020828403121561215757600080fd5b813567ffffffffffffffff81111561216e57600080fd5b611b1d848285016120a0565b60006020828403121561218c57600080fd5b813567ffffffffffffffff808211156121a457600080fd5b90830190604082860312156121b857600080fd5b6121c0611c25565b8235828111156121cf57600080fd5b6121db878286016120a0565b8252506020830135828111156121f057600080fd5b6121fc87828601611cdc565b60208301525095945050505050565b60006020828403121561221d57600080fd5b813567ffffffffffffffff8082111561223557600080fd5b908301906080828603121561224957600080fd5b612251611c4e565b82358281111561226057600080fd5b61226c87828601611cdc565b82525060208301358281111561228157600080fd5b61228d87828601611cdc565b602083015250604083013560408201526122a960608401611cb8565b606082015295945050505050565b600080604083850312156122ca57600080fd5b6122d383611cb8565b91506122e160208401611cb8565b90509250929050565b6000806000604084860312156122ff57600080fd5b61230884611cb8565b9250602084013567ffffffffffffffff8082111561232557600080fd5b818601915086601f83011261233957600080fd5b81358181111561234857600080fd5b87602082850101111561235a57600080fd5b6020830194508093505050509250925092565b60006020828403121561237f57600080fd5b813567ffffffffffffffff81111561239657600080fd5b820160808185031215611b9357600080fd5b6020815260ff825116602082015260006020830151604080840152611b1d6060840182611f90565b6000602082840312156123e257600080fd5b611b9382611cb8565b60008083601f8401126123fd57600080fd5b50813567ffffffffffffffff81111561241557600080fd5b6020830191508360208260051b850101111561243057600080fd5b9250929050565b6000806000806040858703121561244d57600080fd5b843567ffffffffffffffff8082111561246557600080fd5b612471888389016123eb565b9096509450602087013591508082111561248a57600080fd5b50612497878288016123eb565b95989497509550505050565b600080604083850312156124b657600080fd5b823567ffffffffffffffff8111156124cd57600080fd5b8301604081860312156122d357600080fd5b6000608082840312156124f157600080fd5b611b938383611dd1565b60208152600082516080602084015261251760a0840182611f90565b90506020840151601f198483030160408501526125348282611f90565b9150506040840151606084015273ffffffffffffffffffffffffffffffffffffffff60608501511660808401528091505092915050565b60006020828403121561257d57600080fd5b813567ffffffffffffffff81111561259457600080fd5b611b1d84828501612020565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600083516125e1818460208801611f6c565b9190910191825250602001919050565b60006020828403121561260357600080fd5b81358015158114611b9357600080fd5b600082357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8183360301811261264757600080fd5b9190910192915050565b60008083357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe184360301811261268657600080fd5b83018035915067ffffffffffffffff8211156126a157600080fd5b60200191503681900382131561243057600080fd5b60008083357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe18436030181126126eb57600080fd5b83018035915067ffffffffffffffff82111561270657600080fd5b6020019150600581901b360382131561243057600080fd5b600082357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6183360301811261264757600080fd5b6000808585111561276257600080fd5b8386111561276f57600080fd5b5050820193919092039150565b60008083357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe18436030181126127b157600080fd5b83018035915067ffffffffffffffff8211156127cc57600080fd5b6020019150600781901b360382131561243057600080fd5b6000602082840312156127f657600080fd5b611b9382611ca2565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b808201808211156107b4576107b46127ff565b600060ff821660ff8103612857576128576127ff565b60010192915050565b60008251612647818460208701611f6c565b60006107b436836120a0565b7fffffffffffffffffffffffff0000000000000000000000000000000000000000813581811691600c8510156128be57808186600c0360031b1b83161692505b50509291505056fea164736f6c6343000817000a";

    bytes32 internal constant PLUG_SOCKET_SALT =
        0x00000000000000000000000000000000000000009f814a4c1f7fc627d75d6b61;

    address internal constant PLUG_SOCKET_ADDRESS = 0x000000000c3259Da18fFb84f974c241e87ddf2D5;

    bytes internal constant PLUG_INITCODE =
        hex"6080604052600080546001600160a01b0319166f3fdc72a49f043b8fa5f417610a9842f417905534801561003257600080fd5b506110fc806100426000396000f3fe60806040526004361061003f5760003560e01c806306fdde03146100445780635b101f541461009c5780636d0cd94f146100b157806395d89b41146100c4575b600080fd5b34801561005057600080fd5b5060408051808201909152600481527f506c75670000000000000000000000000000000000000000000000000000000060208201525b60405161009391906106d8565b60405180910390f35b6100af6100aa3660046106f2565b61010a565b005b6100af6100bf36600461072d565b610150565b3480156100d057600080fd5b5060408051808201909152600481527f504c5547000000000000000000000000000000000000000000000000000000006020820152610086565b7f387ebc2286e5f30aa44f4fde230e7badbbf2ed0322ac8455948821987c41459e600061013783336101df565b6040516101459291906107cc565b60405180910390a150565b8060005b818160ff1610156101d9577f387ebc2286e5f30aa44f4fde230e7badbbf2ed0322ac8455948821987c41459e816101b186868560ff16818110610199576101996107e8565b90506020028101906101ab9190610817565b336101df565b6040516101bf9291906107cc565b60405180910390a1806101d181610884565b915050610154565b50505050565b6040805180820190915260008152606060208201526101fd83610524565b73ffffffffffffffffffffffffffffffffffffffff1663af433c7c84846040518363ffffffff1660e01b8152600401610237929190610b30565b6000604051808303816000875af192505050801561027757506040513d6000823e601f3d908101601f191682016040526102749190810190610db2565b60015b61051b57610283610e48565b806308c379a0036102ce5750610297610e64565b806102a25750610339565b6040518060400160405280600160ff6102bb9190610f0c565b60ff16815260200191909152905061051e565b634e487b7103610339576102e0610f25565b906102eb5750610339565b6040518060400160405280600260ff6103049190610f0c565b60ff1681526020018260405160200161031f91815260200190565b60405160208183030381529060405281525091505061051e565b3d808015610363576040519150601f19603f3d011682016040523d82523d6000602084013e610368565b606091505b506004815110156103d5576040518060400160405280600460ff61038c9190610f0c565b60ff1681526020016040518060400160405280600f81526020017f506c75673a656d7074792d64617461000000000000000000000000000000000081525081525091505061051e565b7fcd0e1401000000000000000000000000000000000000000000000000000000006103ff82610f45565b7fffffffff000000000000000000000000000000000000000000000000000000001614610488576040518060400160405280600360ff61043f9190610f0c565b60ff1681526020016040518060400160405280601581526020017f506c75673a756e6b6e6f776e2d73656c6563746f72000000000000000000000081525081525091505061051e565b60405181517ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc01808252602483016020830160005b838110156104d55782810151828201526020016104bd565b50505080602001820160405250600080828060200190518101906104f99190610f95565b6040805180820190915260ff90921682526020820152945061051e9350505050565b90505b92915050565b6000806105318380610fe6565b61053f90602081019061101a565b90508073ffffffffffffffffffffffffffffffffffffffff163b60000361051e576000805473ffffffffffffffffffffffffffffffffffffffff16627743606105888680610fe6565b610596906060810190611037565b6040518363ffffffff1660e01b81526004016105b392919061109c565b60408051808303816000875af11580156105d1573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906105f591906110b0565b9150508073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1614610681576040517f5a4be8f400000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff80841660048301528216602482015260440160405180910390fd5b5092915050565b60005b838110156106a357818101518382015260200161068b565b50506000910152565b600081518084526106c4816020860160208601610688565b601f01601f19169290920160200192915050565b6020815260006106eb60208301846106ac565b9392505050565b60006020828403121561070457600080fd5b813567ffffffffffffffff81111561071b57600080fd5b82016040818503121561051b57600080fd5b6000806020838503121561074057600080fd5b823567ffffffffffffffff8082111561075857600080fd5b818501915085601f83011261076c57600080fd5b81358181111561077b57600080fd5b8660208260051b850101111561079057600080fd5b60209290920196919550909350505050565b60ff815116825260006020820151604060208501526107c460408501826106ac565b949350505050565b60ff831681526040602082015260006107c460408301846107a2565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600082357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc183360301811261084b57600080fd5b9190910192915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600060ff821660ff810361089a5761089a610855565b60010192915050565b73ffffffffffffffffffffffffffffffffffffffff811681146108c557600080fd5b50565b60ff811681146108c557600080fd5b60008083357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe184360301811261090c57600080fd5b830160208101925035905067ffffffffffffffff81111561092c57600080fd5b80360382131561093b57600080fd5b9250929050565b818352818160208501375060006020828401015260006020601f19601f840116840101905092915050565b8183526000602080850194508260005b858110156109c3578135875282820135610996816108c8565b60ff168784015260408281013590880152606080830135908801526080968701969091019060010161097d565b509495945050505050565b60008383855260208086019550808560051b8301018460005b87811015610b2357601f1985840301895281357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff61883603018112610a2a57600080fd5b870160a08135610a39816108c8565b60ff16855281860135610a4b816108a3565b73ffffffffffffffffffffffffffffffffffffffff16858701526040610a73838201846108d7565b8383890152610a858489018284610942565b935050505060608083013581870152506080808301357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe1843603018112610acb57600080fd5b90920186810192903567ffffffffffffffff811115610ae957600080fd5b8060071b3603841315610afb57600080fd5b86830382880152610b0d83828661096d565b9c88019c965050509285019250506001016109e7565b5090979650505050505050565b60408152600083357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff81853603018112610b6857600080fd5b60408381015284018035610b7b816108a3565b73ffffffffffffffffffffffffffffffffffffffff1660808401526020810135368290037fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe1018112610bcc57600080fd5b810160208101903567ffffffffffffffff811115610be957600080fd5b8060051b3603821315610bfb57600080fd5b608060a0860152610c11610100860182846109ce565b915050610c2160408301836108d7565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff80808785030160c0880152610c57848385610942565b9350610c6660608601866108d7565b95509250808785030160e08801525050610c81828483610942565b92505050610c9260208601866108d7565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc0858403016060860152610cc7838284610942565b93505050506106eb602083018473ffffffffffffffffffffffffffffffffffffffff169052565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b601f19601f830116810181811067ffffffffffffffff82111715610d4357610d43610cee565b6040525050565b600082601f830112610d5b57600080fd5b815167ffffffffffffffff811115610d7557610d75610cee565b604051610d8c6020601f19601f8501160182610d1d565b818152846020838601011115610da157600080fd5b6107c4826020830160208701610688565b600060208284031215610dc457600080fd5b815167ffffffffffffffff80821115610ddc57600080fd5b9083019060408286031215610df057600080fd5b604051604081018181108382111715610e0b57610e0b610cee565b6040528251610e19816108c8565b8152602083015182811115610e2d57600080fd5b610e3987828601610d4a565b60208301525095945050505050565b600060033d1115610e615760046000803e5060005160e01c5b90565b600060443d1015610e725790565b6040517ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc803d016004833e81513d67ffffffffffffffff8160248401118184111715610ec057505050505090565b8285019150815181811115610ed85750505050505090565b843d8701016020828501011115610ef25750505050505090565b610f0160208286010187610d1d565b509095945050505050565b60ff828116828216039081111561051e5761051e610855565b60008060233d1115610f41576020600460003e50506000516001905b9091565b6000815160208301517fffffffff0000000000000000000000000000000000000000000000000000000080821693506004831015610f8d5780818460040360031b1b83161693505b505050919050565b60008060408385031215610fa857600080fd5b8251610fb3816108c8565b602084015190925067ffffffffffffffff811115610fd057600080fd5b610fdc85828601610d4a565b9150509250929050565b600082357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8183360301811261084b57600080fd5b60006020828403121561102c57600080fd5b813561051b816108a3565b60008083357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe184360301811261106c57600080fd5b83018035915067ffffffffffffffff82111561108757600080fd5b60200191503681900382131561093b57600080fd5b6020815260006107c4602083018486610942565b600080604083850312156110c357600080fd5b825180151581146110d357600080fd5b60208401519092506110e4816108a3565b80915050925092905056fea164736f6c6343000817000a";

    bytes32 internal constant PLUG_SALT =
        0x0000000000000000000000000000000000000000dcae44502fc1ed0fa897bd1a;

    address internal constant PLUG_ADDRESS = 0x0000000071317616b05312fd5DA2E10dAACcaC3C;

    /**
     * @notice Deploy (if needed) and return the PlugFactory contract instance.
     * @return $plugFactory The PlugFactory contract instance.
     */
    function plugFactory() internal returns (PlugFactory $plugFactory) {
        require(
            keccak256(abi.encodePacked(type(PlugFactory).creationCode))
                == keccak256(abi.encodePacked(PLUG_FACTORY_INITCODE)),
            "PlugEtcherLib:invalid-initcode"
        );

        if (_extcodesize(PLUG_FACTORY_ADDRESS) == 0) {
            address reality = safeCreate2(PLUG_FACTORY_SALT, PLUG_FACTORY_INITCODE);
            require(reality == PLUG_FACTORY_ADDRESS, "PlugEtcherLib:unexpected-address");
        }

        $plugFactory = PlugFactory(payable(PLUG_FACTORY_ADDRESS));
    }

    /**
     * @notice Deploy (if needed) and return the PlugSocket contract instance.
     * @return $plugSocket The PlugSocket contract instance.
     */
    function plugSocket() internal returns (PlugSocket $plugSocket) {
        require(
            keccak256(abi.encodePacked(type(PlugSocket).creationCode))
                == keccak256(abi.encodePacked(PLUG_SOCKET_INITCODE)),
            "PlugEtcherLib:invalid-initcode"
        );

        if (_extcodesize(PLUG_SOCKET_ADDRESS) == 0) {
            address reality = safeCreate2(PLUG_SOCKET_SALT, PLUG_SOCKET_INITCODE);
            require(reality == PLUG_SOCKET_ADDRESS, "PlugEtcherLib:unexpected-address");
        }

        $plugSocket = PlugSocket(payable(PLUG_SOCKET_ADDRESS));
    }

    /**
     * @notice Deploy (if needed) and return the Plug contract instance.
     * @return $plug The Plug contract instance.
     */
    function plug() internal returns (Plug $plug) {
        require(
            keccak256(abi.encodePacked(type(Plug).creationCode))
                == keccak256(abi.encodePacked(PLUG_INITCODE)),
            "PlugEtcherLib:invalid-initcode"
        );

        if (_extcodesize(PLUG_ADDRESS) == 0) {
            address reality = safeCreate2(PLUG_SALT, PLUG_INITCODE);
            require(reality == PLUG_ADDRESS, "PlugEtcherLib:unexpected-address");
        }

        $plug = Plug(payable(PLUG_ADDRESS));
    }

    /**
     * @notice Deploys a contract via 0age's immutable create 2 factory for testing.
     * @param $salt The salt to use for the deployment.
     * @param $initializationCode The initialization code for the contract.
     * @return $deployment The address of the deployed contract.
     */
    function safeCreate2(
        bytes32 $salt,
        bytes memory $initializationCode
    )
        public
        returns (address $deployment)
    {
        // Canonical address of 0age's immutable create 2 factory.
        address c2f = 0x0000000000FFe8B47B3e2130213B802212439497;
        if (_extcodesize(c2f) == 0) {
            bytes memory ic2fBytecode =
                hex"60806040526004361061003f5760003560e01c806308508b8f1461004457806364e030871461009857806385cf97ab14610138578063a49a7c90146101bc575b600080fd5b34801561005057600080fd5b506100846004803603602081101561006757600080fd5b503573ffffffffffffffffffffffffffffffffffffffff166101ec565b604080519115158252519081900360200190f35b61010f600480360360408110156100ae57600080fd5b813591908101906040810160208201356401000000008111156100d057600080fd5b8201836020820111156100e257600080fd5b8035906020019184600183028401116401000000008311171561010457600080fd5b509092509050610217565b6040805173ffffffffffffffffffffffffffffffffffffffff9092168252519081900360200190f35b34801561014457600080fd5b5061010f6004803603604081101561015b57600080fd5b8135919081019060408101602082013564010000000081111561017d57600080fd5b82018360208201111561018f57600080fd5b803590602001918460018302840111640100000000831117156101b157600080fd5b509092509050610592565b3480156101c857600080fd5b5061010f600480360360408110156101df57600080fd5b508035906020013561069e565b73ffffffffffffffffffffffffffffffffffffffff1660009081526020819052604090205460ff1690565b600083606081901c33148061024c57507fffffffffffffffffffffffffffffffffffffffff0000000000000000000000008116155b6102a1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260458152602001806107746045913960600191505060405180910390fd5b606084848080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920182905250604051855195965090943094508b93508692506020918201918291908401908083835b6020831061033557805182527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe090920191602091820191016102f8565b51815160209384036101000a7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff018019909216911617905260408051929094018281037fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe00183528085528251928201929092207fff000000000000000000000000000000000000000000000000000000000000008383015260609890981b7fffffffffffffffffffffffffffffffffffffffff00000000000000000000000016602183015260358201969096526055808201979097528251808203909701875260750182525084519484019490942073ffffffffffffffffffffffffffffffffffffffff81166000908152938490529390922054929350505060ff16156104a7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252603f815260200180610735603f913960400191505060405180910390fd5b81602001825188818334f5955050508073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff161461053a576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260468152602001806107b96046913960600191505060405180910390fd5b50505073ffffffffffffffffffffffffffffffffffffffff8116600090815260208190526040902080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff001660011790559392505050565b6000308484846040516020018083838082843760408051919093018181037fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe001825280845281516020928301207fff000000000000000000000000000000000000000000000000000000000000008383015260609990991b7fffffffffffffffffffffffffffffffffffffffff000000000000000000000000166021820152603581019790975260558088019890985282518088039098018852607590960182525085519585019590952073ffffffffffffffffffffffffffffffffffffffff81166000908152948590529490932054939450505060ff909116159050610697575060005b9392505050565b604080517fff000000000000000000000000000000000000000000000000000000000000006020808301919091523060601b6021830152603582018590526055808301859052835180840390910181526075909201835281519181019190912073ffffffffffffffffffffffffffffffffffffffff81166000908152918290529190205460ff161561072e575060005b9291505056fe496e76616c696420636f6e7472616374206372656174696f6e202d20636f6e74726163742068617320616c7265616479206265656e206465706c6f7965642e496e76616c69642073616c74202d206669727374203230206279746573206f66207468652073616c74206d757374206d617463682063616c6c696e6720616464726573732e4661696c656420746f206465706c6f7920636f6e7472616374207573696e672070726f76696465642073616c7420616e6420696e697469616c697a6174696f6e20636f64652ea265627a7a723058202bdc55310d97c4088f18acf04253db593f0914059f0c781a9df3624dcef0d1cf64736f6c634300050a0032";
            /// @solidity memory-safe-assembly
            assembly {
                let m := mload(0x40)
                mstore(m, 0xb4d6c782) // `etch(address,bytes)`.
                mstore(add(m, 0x20), c2f)
                mstore(add(m, 0x40), 0x40)
                let n := mload(ic2fBytecode)
                mstore(add(m, 0x60), n)
                for { let i := 0 } lt(i, n) { i := add(0x20, i) } {
                    mstore(add(add(m, 0x80), i), mload(add(add(ic2fBytecode, 0x20), i)))
                }
                let vmAddress := 0x7109709ECfa91a80626fF3989D68f67F5b1DD12D
                if iszero(call(gas(), vmAddress, 0, add(m, 0x1c), add(n, 0x64), 0x00, 0x00)) {
                    revert(0, 0)
                }
            }
        }
        /// @solidity memory-safe-assembly
        assembly {
            let m := mload(0x40)
            let n := mload($initializationCode)
            mstore(m, 0x64e03087) // `safeCreate2(bytes32,bytes)`.
            mstore(add(m, 0x20), $salt)
            mstore(add(m, 0x40), 0x40)
            mstore(add(m, 0x60), n)
            // prettier-ignore
            for { let i := 0 } lt(i, n) { i := add(i, 0x20) } {
                mstore(add(add(m, 0x80), i), mload(add(add($initializationCode, 0x20), i)))
            }
            if iszero(call(gas(), c2f, 0, add(m, 0x1c), add(n, 0x64), m, 0x20)) {
                returndatacopy(m, m, returndatasize())
                revert(m, returndatasize())
            }
            $deployment := mload(m)
        }
    }

    /**
     * @notice Determine and retrieve the extcodesize of `deployment`.
     * @param $deployment The address to check.
     * @return $result The size of the code at `deployment`.
     */
    function _extcodesize(address $deployment) private view returns (uint256 $result) {
        /// @solidity memory-safe-assembly
        assembly {
            $result := extcodesize($deployment)
        }
    }
}
