// SPDX-License-Identifier: MIT

pragma solidity 0.8.23;

import { PlugLib } from "../libraries/Plug.Lib.sol";
import { PlugFactory } from "../base/Plug.Factory.sol";
import { PlugSocket } from "../base/Plug.Socket.sol";
import { Plug } from "../base/Plug.sol";

interface ImmutableCreate2Factory {
    function safeCreate2(
        bytes32 salt,
        bytes calldata initCode
    )
        external
        payable
        returns (address deploymentAddress);

    function findCreate2Address(
        bytes32 salt,
        bytes calldata initCode
    )
        external
        view
        returns (address deploymentAddress);

    function findCreate2AddressViaHash(
        bytes32 salt,
        bytes32 initCodeHash
    )
        external
        view
        returns (address deploymentAddress);
}

/**
 * @title Plug Etcher
 * @notice This contract is the basis of the automatically generated Plug Etcher
 *         contract used to deploy and write the proper addresses. If you need to add
 *         a new etch into the vm stack for testing, you will do so through the file
 *         found at: /lib/functions/etcher.ts
 * @notice A good portion of this model comes from:
 *         https://github.com/Vectorized/multicaller/blob/main/src/MulticallerEtcher.sol
 *         I am not a Foundry expert. If there is a better way to do this, please let me
 *         know because this is a lot of work just to get a contract deployed when you're
 *         doing anything more than a simple in-and-out contract.
 * @author vectorized (twitter:@optimizoor)
 */
library PlugEtcherLib {
    /// @notice The immutable Create2 factory used for deployment.
    ImmutableCreate2Factory internal constant FACTORY =
        ImmutableCreate2Factory(0x0000000000FFe8B47B3e2130213B802212439497);

    bytes internal constant PLUG_FACTORY_INITCODE =
        hex"60808060405234610016576105e9908161001c8239f35b600080fdfe6080604081815260048036101561001557600080fd5b600092833560e01c91826277436014610175575050806375fd9f281461013057637ac4ed641461004457600080fd5b3461012c57807ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261012c579073ffffffffffffffffffffffffffffffffffffffff6020926101096100966105b4565b90604051917fcc3735a920a3ca505d382bbc545af43d6000803e6038573d6000fd5b3d6000f36060527f5155f3363d3d373d3d363d7f360894a13ba1a3210667c828492db98dca3e2076604052616009602052601e5268603d3d8160223d3973600a52605f602120916040526000606052565b60ff84536035523060601b60015260243560155260558320926035525191168152f35b5080fd5b503461012c5760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261012c5760209061016e6100966105b4565b9051908152f35b848491602091827ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126105b15781359467ffffffffffffffff908187116105ad57366023880112156105ad57868401358281116105a957366024828a0101116105a95760801161054f575060448601359173ffffffffffffffffffffffffffffffffffffffff93848416928560848a0135169889158015610547575b6104f3578851997fffffffffffffffffffffffffffffffffffffffff000000000000000000000000898c01977fffffffffffffffffffffffff0000000000000000000000000000000000000000602485013560a01b16895260601b16602c8c0152888b52898b01908b8210848311176104c757818b528b519751978a8110610495575b5085977fcc3735a920a3ca505d382bbc545af43d6000803e6038573d6000fd5b3d6000f36060527f5155f3363d3d373d3d363d7f360894a13ba1a3210667c828492db98dca3e20768c526160098b5281601e5268603d3d8160223d3973600a52605f9881605560219f605f60212060758201523060581b875260ff87530152605584209934159e8b3b1561046f5750505060019c6104655786388180348d5af115610459578b9c838c9d5b5287606052159b8c610360575b8c8e918c8c8451931584521690820152f35b837f32c7564be3bbeabe66360c08d019367b0d744fcb948046d92552c00c9743dd10928a9552a386861690813b15610455578a517f485cc95500000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff96871685820190815260649290920135891690961660208201528491869182908490829060400103925af1801561044b5761040c575b808080808a61034e565b831161041f575050855285808080610402565b9060416024927f4e487b7100000000000000000000000000000000000000000000000000000000835252fd5b89513d85823e3d90fd5b8480fd5b8563b12d13eb8852601cfd5b8b9c838c9d610341565b90919e50829a5034f5978815610489578b9c838c9d610341565b8563301164258852601cfd5b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff908b0360031b1b909716968c610296565b6024866041877f4e487b7100000000000000000000000000000000000000000000000000000000835252fd5b88517f54f044c400000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff808c16828601908152908716602082015281906040010390fd5b508415610213565b8085857f08c379a00000000000000000000000000000000000000000000000000000000060649452820152601760248201527f506c7567436f72653a73616c742d6d616c666f726d65640000000000000000006044820152fd5b8380fd5b8280fd5b80fd5b6004359073ffffffffffffffffffffffffffffffffffffffff821682036105d757565b600080fdfea164736f6c6343000817000a";

    bytes32 internal constant PLUG_FACTORY_SALT =
        0x00000000000000000000000000000000000000003abd8e2464a0a939aed050af;

    address internal constant PLUG_FACTORY_ADDRESS = 0x000000002D0BacD773C6055c22650A6B85a2990B;

    bytes internal constant PLUG_SOCKET_INITCODE =
        hex"60a0806040523461007557306080526001638b78c6d81955600160007f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08180a3600160005260026020526040600020600160ff19825416179055612b21908161007b823960805181818161091c0152610a2a0152f35b600080fdfe60806040526004361015610015575b36611a4157005b60003560e01c806306fdde03146101f55780630d6a5f4d146101f05780631e2950fb146101eb57806325692962146101e657806327020df5146101e157806334bb3700146101dc578063485cc955146101d75780634f1ef286146101d257806352d1902d146101cd57806354d1f13d146101c857806354fd4d50146101c357806360cd27ad146101be5780636f69f3d6146101b9578063715018a6146101b4578063733564b7146101af578063812a4729146101aa578063816a1e5f146101a557806385ab746d146101a05780638954bf061461019b5780638da5cb5b1461019657806395d89b4114610191578063969f7e1b1461018c578063b496003d14610187578063be04d3d614610182578063c2fb26a61461017d578063dfe86ac514610178578063e7d1bfc714610173578063f04e283e1461016e578063f2fde38b146101695763fee81cf40361000e576114de565b61149e565b611448565b61136f565b611351565b61128e565b61124e565b611236565b6111fb565b611149565b611111565b6110bc565b611027565b610dc4565b610d57565b610d12565b610c4a565b610b5c565b610adb565b610abf565b610a78565b610a16565b6108cb565b610817565b610762565b610727565b6106d8565b6106c0565b6106a0565b610256565b60005b83811061020d5750506000910152565b81810151838201526020016101fd565b90601f19601f60209361023b815180928187528780880191016101fa565b0116010190565b90602061025392818152019061021d565b90565b3461028a57600060031936011261028a57610286610272611539565b60405191829160208352602083019061021d565b0390f35b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6080810190811067ffffffffffffffff8211176102da57604052565b61028f565b6040810190811067ffffffffffffffff8211176102da57604052565b60c0810190811067ffffffffffffffff8211176102da57604052565b90601f601f19910116810190811067ffffffffffffffff8211176102da57604052565b60405190610347826102df565b565b73ffffffffffffffffffffffffffffffffffffffff81160361028a57565b359061034782610349565b67ffffffffffffffff81116102da5760051b60200190565b60ff81160361028a57565b67ffffffffffffffff81116102da57601f01601f191660200190565b9291926103bd82610395565b916103cb6040519384610317565b82948184528183011161028a578281602093846000960137010152565b9080601f8301121561028a57816020610253933591016103b1565b919082608091031261028a5760405161041b816102be565b6060808294803561042b8161038a565b8452602081013560208501526040810135604085015201359161044d8361038a565b0152565b81601f8201121561028a57803590602061046a83610372565b9360409061047b6040519687610317565b848652828601918360a08097028601019482861161028a578401925b8584106104a8575050505050505090565b868484031261028a5784879183516104bf816102df565b863581526104cf86848901610403565b83820152815201930192610497565b91909160a08184031261028a576040519067ffffffffffffffff9060a08301828111848210176102da57604052829481356105188161038a565b845261052660208301610367565b6020850152604082013583811161028a57816105439184016103e8565b604085015260608201356060850152608082013592831161028a5760809261056b9201610451565b910152565b81601f8201121561028a5780359160209161058a84610372565b936105986040519586610317565b808552838086019160051b8301019280841161028a57848301915b8483106105c35750505050505090565b823567ffffffffffffffff811161028a5786916105e5848480948901016104de565b8152019201916105b3565b919060808382031261028a5760405190610609826102be565b8193803561061681610349565b835267ffffffffffffffff91602082013583811161028a578161063a918401610570565b6020850152604082013583811161028a57816106579184016103e8565b6040850152606082013592831161028a5760609261056b92016103e8565b602060031982011261028a576004359067ffffffffffffffff821161028a57610253916004016105f0565b3461028a5760206106b86106b336610675565b611572565b604051908152f35b3461028a5760206106b86106d336610675565b611605565b6000806003193601126107245763389a75e1600c523381526202a30042016020600c2055337fdbf36a107da19e49527a7176a1babf963b4b0ff8cde35ee35d6cd8f1f9ac7e1d8280a280f35b80fd5b3461028a57602060031936011261028a5760043567ffffffffffffffff811161028a576106b861075d60209236906004016104de565b611654565b3461028a5760031960208136011261028a5760043567ffffffffffffffff9182821161028a57608090823603011261028a576040516107a0816102be565b816004013583811161028a576107bc90600436918501016103e8565b8152602482013592831161028a576064610807926107e361028695600436918401016103e8565b60208401526044810135604084015201356107fd81610349565b60608201526116ff565b6040519081529081906020820190565b3461028a57604060031936011261028a5760043561083481610349565b6024359061084182610349565b73ffffffffffffffffffffffffffffffffffffffff8091169182638b78c6d81955600092837f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08180a31680610894575080f35b815260026020526040812060017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0082541617905580f35b604060031936011261028a576004356108e381610349565b60243567ffffffffffffffff9182821161028a573660238301121561028a57816004013592831161028a57366024848401011161028a577f00000000000000000000000000000000000000000000000000000000000000003014610a085773ffffffffffffffffffffffffffffffffffffffff9061095f611a79565b16913d9260009384526352d1902d6001527f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc9182602060016004601d865afa51036109fa5780828694817fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b8780a2556109d6578280f35b806024604051950185378338925af4156109f1578181808280f35b903d90823e3d90fd5b6355299b496001526004601dfd5b639f03a0266000526004601cfd5b3461028a57600060031936011261028a57307f000000000000000000000000000000000000000000000000000000000000000003610a085760206040517f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc8152f35b6000806003193601126107245763389a75e1600c52338152806020600c2055337ffa7b8eab7da67f412cc9575ed43464468f9bfbae89d1675917346ca6d8fe3c928280a280f35b3461028a57600060031936011261028a57610286610272611784565b3461028a57602060031936011261028a5773ffffffffffffffffffffffffffffffffffffffff600435610b0d81610349565b166000526002602052602060ff604060002054166040519015158152f35b9181601f8401121561028a5782359167ffffffffffffffff831161028a576020808501948460051b01011161028a57565b3461028a5760408060031936011261028a5767ffffffffffffffff9060043582811161028a57610b90903690600401610b2b565b909260243590811161028a57610baa903690600401610b2b565b610bb5939193611a79565b60005b838110610bc157005b610bcc8183876117ec565b3590811515820361028a57610c4460019273ffffffffffffffffffffffffffffffffffffffff610bfd84898c6117ec565b35610c0781610349565b166000526002602052856000209060ff7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0083541691151516179055565b01610bb8565b60008060031936011261072457610c5f611a79565b80638b78c6d8198181547f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08280a35580f35b919060408382031261028a5760405190610caa826102df565b819380359167ffffffffffffffff9283811161028a5781610ccc9184016105f0565b8452602082013592831161028a5760209261056b92016103e8565b602060031982011261028a576004359067ffffffffffffffff821161028a5761025391600401610c91565b3461028a576020610d39610d2536610ce7565b82610d308251611605565b91015190611add565b73ffffffffffffffffffffffffffffffffffffffff60405191168152f35b3461028a57602060031936011261028a5760043567ffffffffffffffff811161028a576106b8610d8d6020923690600401610451565b611856565b9081604091031261028a5790565b606060206102539381845260ff81511682850152015191604080820152019061021d565b604060031936011261028a5760043567ffffffffffffffff811161028a57610df0903690600401610d92565b60243590610dfd82610349565b610e0561189f565b5068929eee149b4bd21268903082541461101957308255610e51610e346106d3610e2f84806118b9565b611b87565b610e4b610e446020850185611b92565b36916103b1565b90611add565b610e8e610e7d610e77610e71610e6786806118b9565b6060810190611b92565b90611be3565b60a01c90565b6bffffffffffffffffffffffff1690565b6001610eb1826001908060081c6000528160205260ff60406000205491161c1690565b151514610fc557610edb908060081c6000526001602052600160ff604060002092161b8154179055565b610f0f610f088273ffffffffffffffffffffffffffffffffffffffff166000526002602052604060002090565b5460ff1690565b908115610f9b575b5015610f435761028692610f2e82610f33936118b9565b612626565b9038905560405191829182610da0565b60405163cd0e140160e01b815280610f976004820160809060ff815260406020820152601a60408201527f506c7567436f72653a7369676e61747572652d696e76616c696400000000000060608201520190565b0390fd5b638b78c6d8195473ffffffffffffffffffffffffffffffffffffffff908116911614905038610f17565b60405163cd0e140160e01b815280610f976004820160809060ff815260406020820152601660408201527f506c7567436f72653a6e6f6e63652d696e76616c69640000000000000000000060608201520190565b63ab143c066000526004601cfd5b3461028a5760a060031936011261028a57604051611044816102df565b600435815260807fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdc36011261028a576106b8602091604051611085816102be565b6024356110918161038a565b81526044358482015260643560408201526084356110ae8161038a565b6060820152838201526118ec565b3461028a57608060031936011261028a5760206106b86040516110de816102be565b6004356110ea8161038a565b81526024358382015260443560408201526064356111078161038a565b606082015261193e565b3461028a57600060031936011261028a576020638b78c6d8195473ffffffffffffffffffffffffffffffffffffffff60405191168152f35b3461028a5760008060031936011261072457611163611539565b805160408051938285526020908094815b8581106111c8578787600581116111c0575b80156111ad575b80601f1991835282016111a860208201938460405284610242565b030190f35b5064504c5547536020820152600461118d565b506005611186565b838183010151831a605b8110868211166111e6575b50600101611174565b8760019298918684938c0101530196906111dd565b3461028a57602060031936011261028a5760043567ffffffffffffffff811161028a576106b86112316020923690600401610570565b6119a5565b3461028a5760206106b861124936610ce7565b6119e8565b3461028a57602060031936011261028a5760043567ffffffffffffffff811161028a576106b861124960209261128936913690600401610d92565b610c91565b3461028a57600060031936011261028a5761132c60406000606082516112b3816102be565b818152816020820152828482015201526112cb611539565b9073ffffffffffffffffffffffffffffffffffffffff6112e9611784565b918051936112f6856102be565b84526020840192835261133f81850193468552606086019230845280519788976020895251608060208a015260a089019061021d565b915190601f19888403019088015261021d565b92516060850152511660808301520390f35b3461028a57600060031936011261028a576020600054604051908152f35b60031960208136011261028a576004359067ffffffffffffffff821161028a57608090823603011261028a576113a361189f565b5068929eee149b4bd21268308154146110195730815573ffffffffffffffffffffffffffffffffffffffff638b78c6d81954163314801561143f575b156113f357610f3361028692600401611e18565b608460405163cd0e140160e01b815260ff600482015260406024820152601760448201527f506c7567436f72653a73656e6465722d696e76616c69640000000000000000006064820152fd5b503033146113df565b602060031936011261028a5760043561146081610349565b611468611a79565b63389a75e1600c52806000526020600c20908154421161149057600061148e9255611a96565b005b636f5e88186000526004601cfd5b602060031936011261028a576004356114b681610349565b6114be611a79565b8060601b156114d05761148e90611a96565b637448fbae6000526004601cfd5b3461028a57602060031936011261028a576004356114fb81610349565b63389a75e1600c52600052602080600c2054604051908152f35b604051906020820182811067ffffffffffffffff8211176102da5760405260008252565b60405190611546826102df565b600b82527f506c756720536f636b65740000000000000000000000000000000000000000006020830152565b73ffffffffffffffffffffffffffffffffffffffff8151169061159860208201516119a5565b90606060408201516020815191012091015160208151910120906040519260208401947fad37dd17963f530e0696a34fb50e96c004ad0a3380a5e9c1dc82de9eb692b5d9865260408501526060840152608083015260a082015260a081526115ff816102fb565b51902090565b61161160005491611572565b6040519060208201927f1901000000000000000000000000000000000000000000000000000000000000845260228301526042820152604281526115ff816102be565b60ff8151169073ffffffffffffffffffffffffffffffffffffffff602082015116906040810151602081519101209061169560806060830151920151611856565b916040519360208501957f8adbed414e194dcdb13ff4e505a6ab838020fe2e144c9d773a6a63b399104584875260408601526060850152608084015260a083015260c082015260c0815260e0810181811067ffffffffffffffff8211176102da5760405251902090565b805160208151910120906020810151602081519101209073ffffffffffffffffffffffffffffffffffffffff6060604083015192015116906040519260208401947f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f865260408501526060840152608083015260a082015260a081526115ff816102fb565b60405190611791826102df565b600582527f302e302e310000000000000000000000000000000000000000000000000000006020830152565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b91908110156117fc5760051b0190565b6117bd565b3561025381610349565b80518210156117fc5760209160051b010190565b604061034791939293815194816118408793518092602080870191016101fa565b8201906020820152036020810185520183610317565b6060906000908051905b818310611874575050506020815191012090565b90919261189660019161189061188a878661180b565b516118ec565b9061181f565b93019190611860565b604051906118ac826102df565b6060602083600081520152565b9035907fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff818136030182121561028a570190565b6118fb6020825192015161193e565b6040519060208201927f85c9aec0e14ad33e63489c03355fa65515340a998cc26cd360d11267b451b6fd845260408301526060820152606081526115ff816102be565b60ff8151169060208101519060ff6060604083015192015116906040519260208401947ff8939514938e0a800705081290e2e4c7efcf49061b28bf5b38f457c851eb82ac865260408501526060840152608083015260a082015260a081526115ff816102fb565b6060906000908051905b8183106119c3575050506020815191012090565b9091926119df6001916118906119d9878661180b565b51611654565b930191906119af565b60206119f48251611572565b910151602081519101206040519060208201927f4223462a204a553d0ecb26b955c1f59fcf6a0662da793ddfd0d17a33c99b97f2845260408301526060820152606081526115ff816102be565b60003560e01c63bc197c81811463f23a6e6182141763150b7a02821417611a7057633c10b94e6000526004601cfd5b6020526020603cf35b638b78c6d819543303611a8857565b6382b429006000526004601cfd5b73ffffffffffffffffffffffffffffffffffffffff16638b78c6d8198181547f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0600080a355565b909160009160409360405191815180604014611b4e57604114611b0d5750505050638baa579f91505b526004601cfd5b606080830151861a6020528683015190525b845260208091015185526001608085825afa519383606052523d611b4a5750638baa579f9150611b06565b9050565b507f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff86830151601b8160ff1c0160205216606052611b1f565b6102539036906105f0565b9035907fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe18136030182121561028a570180359067ffffffffffffffff821161028a5760200191813603831361028a57565b7fffffffffffffffffffffffff000000000000000000000000000000000000000090358181169392600c8110611c1857505050565b600c0360031b82901b16169150565b9035907fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe18136030182121561028a570180359067ffffffffffffffff821161028a57602001918160051b3603831361028a57565b90611c8582610372565b611c926040519182610317565b828152601f19611ca28294610372565b019060005b828110611cb357505050565b806060602080938501015201611ca7565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60ff1660ff8114611d045760010190565b611cc4565b91908110156117fc5760051b810135907fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff618136030182121561028a570190565b9035907fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe18136030182121561028a570180359067ffffffffffffffff821161028a576020019160a082023603831361028a57565b91908110156117fc5760a0020190565b356102538161038a565b9060208201809211611d0457565b91908201809211611d0457565b908160051b9180830460201490151715611d0457565b3d15611e13573d90611df982610395565b91611e076040519384610317565b82523d6000602084013e565b606090565b611e2061189f565b5060408101611e2f8183611b92565b90506124d5575b50611e446020820182611c27565b929050600091611e5384611c7b565b916000935b8560ff861610156124b357611e7d611e736020850185611c27565b60ff881691611d09565b611e8d610e446040830183611b92565b91611e9b6080830183611d49565b600091505b8082106120335750506001611ebd611eb784611dad565b60ff1690565b03611f595750600091611ed36020849301611801565b602082519201905af4611ee4611de8565b611ef160ff87168661180b565b52935b8415611f0957611f0390611cf3565b93611e58565b6040805163cd0e140160e01b815260ff9290921660048301526024820152601460448201527f506c7567436f72653a706c75672d6661696c65640000000000000000000000006064820152608490fd5b60ff611f6483611dad565b16611fa05750600091611f7a6020849301611801565b82602083519301915af1611f8c611de8565b611f9960ff87168661180b565b5293611ef4565b600260ff611fad84611dad565b1603611fdb575060009181611fc56020859401611801565b6060602084519401920135905af1611f8c611de8565b959190600360ff611feb83611dad565b1614611ff9575b5050611ef4565b60009296509061200c6020849301611801565b602082519201905afa61201d611de8565b61202a60ff87168661180b565b52933880611ff2565b909361204c856120466080870187611d49565b90611d9d565b9061206561205f611eb760208501611dad565b8a61180b565b51612075611eb760808501611dad565b6121a057606083013590604084013561208e8382611dc5565b82511061214f5790816120a4846120aa94611dc5565b91612a73565b9083356120b78282611dc5565b8451106120fe57926120e7600195936120e26120d96120f0956120f698611dc5565b955b35846129f6565b612aa1565b92815191612a73565b90612aa1565b940190611ea0565b6040805163cd0e140160e01b815260ff8f1660048201526024810191909152601760448201527f506c7567436f72653a776f756c642d6f766572666c6f770000000000000000006064820152608490fd5b6040805163cd0e140160e01b815260ff8f1660048201526024810191909152601660448201527f506c7567436f72653a6f75742d6f662d626f756e6473000000000000000000006064820152608490fd5b60208335820101519080518210156124625760208282010151916121cc836121c783611db7565b611dc5565b82511061241157600160ff6121e360808801611dad565b161480156123f9575b156122ff578261220160208385010151611dd2565b116122ae5790612222915b6120a4846121c761221c84611db7565b93611db7565b90612231816121c78635611db7565b83511061225d576120f6926120e785936120e26122576120f0956121c760019a35611db7565b956120db565b6040805163cd0e140160e01b815260ff8e1660048201526024810191909152601760448201527f506c7567436f72653a776f756c642d6f766572666c6f770000000000000000006064820152608490fd5b6040805163cd0e140160e01b815260ff8f1660048201526024810191909152601d60448201527f506c7567436f72653a61727261792d6c656e6774682d696e76616c69640000006064820152608490fd5b600360ff61230f60808801611dad565b1603612378576020831061232757906122229161220c565b6040805163cd0e140160e01b815260ff8f1660048201526024810191909152601960448201527f506c7567436f72653a7374727563742d746f6f2d736d616c6c000000000000006064820152608490fd5b600560ff61238860808801611dad565b1614806123ef575b61239e57906122229161220c565b6040805163cd0e140160e01b815260ff8f1660048201526024810191909152601c60448201527f506c7567436f72653a6b65792d76616c75652d746f6f2d736d616c6c000000006064820152608490fd5b5060408310612390565b50600460ff61240a60808801611dad565b16146121ec565b6040805163cd0e140160e01b815260ff8f1660048201526024810191909152601760448201527f506c7567436f72653a696e76616c69642d6c656e6774680000000000000000006064820152608490fd5b6040805163cd0e140160e01b815260ff8e1660048201526024810191909152601760448201527f506c7567436f72653a696e76616c69642d6f66667365740000000000000000006064820152608490fd5b5093505050506124c161033a565b60ff81526124cd611515565b602082015290565b60406124e18284611b92565b9050106125d2576124f28183611b92565b504290351061257e57602061251c73ffffffffffffffffffffffffffffffffffffffff9284611b92565b5001351661252a5738611e36565b60405163cd0e140160e01b815280610f976004820160809060ff815260406020820152601760408201527f506c7567436f72653a736f6c7665722d696e76616c696400000000000000000060608201520190565b60405163cd0e140160e01b815280610f976004820160809060ff815260406020820152601760408201527f506c7567436f72653a736f6c7665722d6578706972656400000000000000000060608201520190565b60405163cd0e140160e01b815280610f976004820160809060ff815260406020820152601960408201527f506c7567436f72653a736f6c7665722d6d616c666f726d65640000000000000060608201520190565b9061262f61189f565b506040820161263e8184611b92565b905061299a575b50506126546020820182611c27565b92905060009161266384611c7b565b916000935b8560ff861610156124b357612683611e736020850185611c27565b612693610e446040830183611b92565b916126a16080830183611d49565b600091505b8082106127e357505060016126bd611eb784611dad565b0361270957506000916126d36020849301611801565b602082519201905af46126e4611de8565b6126f160ff87168661180b565b52935b8415611f095761270390611cf3565b93612668565b60ff61271483611dad565b16612750575060009161272a6020849301611801565b82602083519301915af161273c611de8565b61274960ff87168661180b565b52936126f4565b600260ff61275d84611dad565b160361278b5750600091816127756020859401611801565b6060602084519401920135905af161273c611de8565b959190600360ff61279b83611dad565b16146127a9575b50506126f4565b6000929650906127bc6020849301611801565b602082519201905afa6127cd611de8565b6127da60ff87168661180b565b529338806127a2565b90936127f6856120466080870187611d49565b9061280961205f611eb760208501611dad565b51612819611eb760808501611dad565b61287f5760608301359060408401356128328382611dc5565b82511061214f5790816120a48461284894611dc5565b9083356128558282611dc5565b8451106120fe57926120e7600195936120e26120d96120f09561287798611dc5565b9401906126a6565b60208335820101519080518210156124625760208282010151916128a6836121c783611db7565b82511061241157600160ff6128bd60808801611dad565b16148015612982575b1561292a57826128db60208385010151611dd2565b116122ae57906128f5916120a4846121c761221c84611db7565b90612904816121c78635611db7565b83511061225d57612877926120e785936120e26122576120f0956121c760019a35611db7565b600360ff61293a60808801611dad565b1603612952576020831061232757906128f59161220c565b600560ff61296260808801611dad565b161480612978575b61239e57906128f59161220c565b506040831061296a565b50600460ff61299360808801611dad565b16146128c6565b60406129a68285611b92565b9050106125d2576129b78184611b92565b504290351061257e576129ca9083611b92565b5090602073ffffffffffffffffffffffffffffffffffffffff809216920135160361252a573880612645565b9190600092606093815183811115612a6b575b8015612a63575b50828110612a1d57505050565b60405194509182900391601f19910181601f840181165b808301518188015201908115612a4c57908290612a34565b505050604081840160006020820152016040528252565b905038612a10565b925082612a09565b805160609493929083811115612a99575b81811115612a635750828110612a1d57505050565b925082612a84565b91909160405192815191601f198091818060208701165b80830151818a015201908115612ad057908290612ab8565b505050815191838601828060208601165b808401518184015201918215612af957918390612ae1565b5050505060409101808401906000602083015284520160405256fea164736f6c6343000817000a";

    bytes32 internal constant PLUG_SOCKET_SALT =
        0x00000000000000000000000000000000000000006586810164d55f24b666d74e;

    address internal constant PLUG_SOCKET_ADDRESS = 0x0000000003a9A36daB7Db73dBeD63EcE13604bFB;

    bytes internal constant PLUG_INITCODE =
        hex"6080806040523461003857600080546001600160a01b0319166f2d0bacd773c6055c22650a6b85a2990b179055610ff4908161003e8239f35b600080fdfe6080604052600436101561001257600080fd5b6000803560e01c90816306fdde031461005a5750806395d89b4114610055578063996d9ed21461005057639987b20c1461004b57600080fd5b61029f565b6101a2565b61013f565b346100b557806003193601126100b55761007460c0604052565b60046080527f506c75670000000000000000000000000000000000000000000000000000000060a05260405160208152806100b1602082016100db565b0390f35b80fd5b60005b8381106100cb5750506000910152565b81810151838201526020016100bb565b906080519182815260005b8381106101065750601f19601f8460006020809697860101520116010190565b8060209160a00151828285010152016100e6565b90601f19601f602093610138815180928187528780880191016100b8565b0116010190565b3461019d57600060031936011261019d576100b160405161015f81610351565b600481527f504c554700000000000000000000000000000000000000000000000000000000602082015260405191829160208352602083019061011a565b600080fd5b602060031936011261019d5760043567ffffffffffffffff80821161019d573660238301121561019d57816004013590811161019d576024906005923660248360051b8301011161019d576101f89391936103c0565b506000917fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff9d82360301925b8560ff82161061022f57005b84611fe082841b16840101358481121561019d576102737f1e3f2addc54f8d082238dc18bbcd6da07074c79dd403489a275c7a8b6ecfaa9c91873391870101610aa4565b610283604051928392868461042c565b0390a160ff80911690811461029a57600101610223565b6103da565b60031960208136011261019d576004359067ffffffffffffffff821161019d57604090823603011261019d576102fa7f1e3f2addc54f8d082238dc18bbcd6da07074c79dd403489a275c7a8b6ecfaa9c913390600401610aa4565b61031d604051928392600084526020840152606060408401526060830190610409565b0390a1005b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040810190811067ffffffffffffffff82111761036d57604052565b610322565b90601f601f19910116810190811067ffffffffffffffff82111761036d57604052565b604051906103a282610351565b565b67ffffffffffffffff811161036d57601f01601f191660200190565b604051906103cd82610351565b6060602083600081520152565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b90604060206104299360ff8151168452015191816020820152019061011a565b90565b610429939260ff60609316825260208201528160408201520190610409565b60ff81160361019d57565b81601f8201121561019d57805161046c816103a4565b9261047a6040519485610372565b8184526020828401011161019d5761042991602080850191016100b8565b9060208282031261019d57815167ffffffffffffffff9283821161019d57019060408282031261019d57604051926104cf84610351565b82516104da8161044b565b8452602083015190811161019d576104f29201610456565b602082015290565b73ffffffffffffffffffffffffffffffffffffffff81160361019d57565b90357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe18236030181121561019d57016020813591019167ffffffffffffffff821161019d57813603831361019d57565b601f8260209493601f19938186528686013760008582860101520116010190565b9190808252602080920192916000905b8282106105a7575050505090565b9091929360019085358152828601356105bf8161044b565b60ff809116848301526040808801359083015260608088013590830152608090818801356105ec8161044b565b169082015260a0908101950193920190610599565b90918092808252602080920191808260051b86010194846000915b84831061062d575050505050505090565b90919293949596601f1982820301875287357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff618436030181121561019d5783019060a09060ff833561067e8161044b565b16815273ffffffffffffffffffffffffffffffffffffffff878401356106a3816104fa565b16878201526106c96040836106ba82870187610518565b91909285015284840191610568565b9260608082013590830152608090818101357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe18236030181121561019d57019388853595019367ffffffffffffffff861161019d5785023603841361019d5760019489948461073e9487968503910152610589565b9901970195949301919061061c565b80357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff818236030181121561019d578101916040815273ffffffffffffffffffffffffffffffffffffffff83356107a2816104fa565b16604082015260208301357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe18436030181121561019d57830160208135910167ffffffffffffffff821161019d578160051b3603811361019d576104299461081c61087b92610886946080606088015260c0870191610601565b61086c61086161082f6040850185610518565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc09491858a84030160808b0152610568565b926060810190610518565b918684030160a0870152610568565b926020810190610518565b916020818503910152610568565b9073ffffffffffffffffffffffffffffffffffffffff6108c160209295949560408552604085019061074d565b9416910152565b6040513d6000823e3d90fd5b60009060033d116108e157565b905060046000803e60005160e01c90565b600060443d106104295760405160031991823d016004833e815167ffffffffffffffff918282113d60248401111761095057818401948551938411610958573d85010160208487010111610950575061042992910160200190610372565b949350505050565b50949350505050565b6000809160233d1161096f57565b9150506020600460003e600051600191565b3d156109ac573d90610992826103a4565b916109a06040519384610372565b82523d6000602084013e565b606090565b604051906109be82610351565b600f82527f506c75673a656d7074792d6461746100000000000000000000000000000000006020830152565b90602082519201517fffffffff00000000000000000000000000000000000000000000000000000000908181169360048110610a2557505050565b60040360031b82901b16169150565b60405190610a4182610351565b601582527f506c75673a756e6b6e6f776e2d73656c6563746f7200000000000000000000006020830152565b91909160408184031261019d578051610a858161044b565b92602082015167ffffffffffffffff811161019d576104299201610456565b9091610b17610ab16103c0565b93610abb84610dcc565b90610ac68583610f49565b94604051928380927f816a1e5f00000000000000000000000000000000000000000000000000000000825273ffffffffffffffffffffffffffffffffffffffff826000988997889460048401610894565b0393165af1829181610ce3575b50610cde57506001610b346108d4565b806308c379a014610cb357634e487b7114610c58575b610b515750565b909250610b5c610981565b6004815110610c41577fcd0e1401000000000000000000000000000000000000000000000000000000007fffffffff00000000000000000000000000000000000000000000000000000000610bb0836109ea565b1603610c2157604051918151916003198301908185526020925b828110610c0d575050505090601c610bf19282010160405260208082518301019101610a6d565b610c05610bfc610395565b60ff9093168352565b602082015291565b818101602401518682018501528301610bca565b505090610c2c610395565b60fc8152610c38610a34565b60208201529190565b505090610c4c610395565b60fb8152610c386109b1565b610c60610961565b90610c6c575b50610b4a565b945050610c8b610c998295604051928391602083019190602083019252565b03601f198101835282610372565b610ca1610395565b60fd8152905b60208201529338610c66565b50610cbc6108f2565b80610cc75750610b4a565b9450508093610cd4610395565b60fe815290610ca7565b935050565b610d009192503d8085833e610cf88183610372565b810190610498565b9038610b24565b9035907fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff818136030182121561019d570190565b35610429816104fa565b9035907fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe18136030182121561019d570180359067ffffffffffffffff821161019d5760200191813603831361019d57565b919082604091031261019d578151801515810361019d57602090920151610429816104fa565b916020610429938181520191610568565b610dde610dd98280610d07565b610d3a565b90813b15610e01575b5073ffffffffffffffffffffffffffffffffffffffff1690565b6040610e9091610e59610e4f610e48610e2f60005473ffffffffffffffffffffffffffffffffffffffff1690565b73ffffffffffffffffffffffffffffffffffffffff1690565b9280610d07565b6060810190610d44565b9190600084518096819582947e77436000000000000000000000000000000000000000000000000000000000845260048401610dbb565b03925af1908115610f4457600091610f13575b5073ffffffffffffffffffffffffffffffffffffffff82811690821614610de7576040517f5a4be8f400000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff928316600482015291166024820152604490fd5b610f35915060403d604011610f3d575b610f2d8183610372565b810190610d95565b905038610ea3565b503d610f23565b6108c8565b610fa160209173ffffffffffffffffffffffffffffffffffffffff936040519485809481937fbe04d3d6000000000000000000000000000000000000000000000000000000008352876004840152602483019061074d565b0392165afa908115610f4457600091610fb8575090565b90506020813d602011610fdf575b81610fd360209383610372565b8101031261019d575190565b3d9150610fc656fea164736f6c6343000817000a";

    bytes32 internal constant PLUG_SALT =
        0x0000000000000000000000000000000000000000242f6b7d4aea9a1a6ba4d5cb;

    address internal constant PLUG_ADDRESS = 0x0000000042A5205A2CCbce044A19d8374E34feC1;

    /**
     * @notice Deploy (if needed) and return the PlugFactory contract instance.
     * @return $plugFactory The PlugFactory contract instance.
     */
    function plugFactory() internal returns (PlugFactory $plugFactory) {
        require(
            keccak256(abi.encodePacked(type(PlugFactory).creationCode))
                == keccak256(abi.encodePacked(PLUG_FACTORY_INITCODE)),
            "PlugEtcherLib:invalid-initcode"
        );

        if (_extcodesize(PLUG_FACTORY_ADDRESS) == 0) {
            address reality = safeCreate2(PLUG_FACTORY_SALT, PLUG_FACTORY_INITCODE);
            require(reality == PLUG_FACTORY_ADDRESS, "PlugEtcherLib:unexpected-address");
        }

        $plugFactory = PlugFactory(payable(PLUG_FACTORY_ADDRESS));
    }

    /**
     * @notice Deploy (if needed) and return the PlugSocket contract instance.
     * @return $plugSocket The PlugSocket contract instance.
     */
    function plugSocket() internal returns (PlugSocket $plugSocket) {
        require(
            keccak256(abi.encodePacked(type(PlugSocket).creationCode))
                == keccak256(abi.encodePacked(PLUG_SOCKET_INITCODE)),
            "PlugEtcherLib:invalid-initcode"
        );

        if (_extcodesize(PLUG_SOCKET_ADDRESS) == 0) {
            address reality = safeCreate2(PLUG_SOCKET_SALT, PLUG_SOCKET_INITCODE);
            require(reality == PLUG_SOCKET_ADDRESS, "PlugEtcherLib:unexpected-address");
        }

        $plugSocket = PlugSocket(payable(PLUG_SOCKET_ADDRESS));
    }

    /**
     * @notice Deploy (if needed) and return the Plug contract instance.
     * @return $plug The Plug contract instance.
     */
    function plug() internal returns (Plug $plug) {
        require(
            keccak256(abi.encodePacked(type(Plug).creationCode))
                == keccak256(abi.encodePacked(PLUG_INITCODE)),
            "PlugEtcherLib:invalid-initcode"
        );

        if (_extcodesize(PLUG_ADDRESS) == 0) {
            address reality = safeCreate2(PLUG_SALT, PLUG_INITCODE);
            require(reality == PLUG_ADDRESS, "PlugEtcherLib:unexpected-address");
        }

        $plug = Plug(payable(PLUG_ADDRESS));
    }

    /**
     * @notice Deploys a contract via 0age's immutable create 2 factory for testing.
     * @param $salt The salt to use for the deployment.
     * @param $initializationCode The initialization code for the contract.
     * @return $deployment The address of the deployed contract.
     */
    function safeCreate2(
        bytes32 $salt,
        bytes memory $initializationCode
    )
        public
        returns (address $deployment)
    {
        // Canonical address of 0age's immutable create 2 factory.
        address c2f = 0x0000000000FFe8B47B3e2130213B802212439497;
        if (_extcodesize(c2f) == 0) {
            bytes memory ic2fBytecode =
                hex"60806040526004361061003f5760003560e01c806308508b8f1461004457806364e030871461009857806385cf97ab14610138578063a49a7c90146101bc575b600080fd5b34801561005057600080fd5b506100846004803603602081101561006757600080fd5b503573ffffffffffffffffffffffffffffffffffffffff166101ec565b604080519115158252519081900360200190f35b61010f600480360360408110156100ae57600080fd5b813591908101906040810160208201356401000000008111156100d057600080fd5b8201836020820111156100e257600080fd5b8035906020019184600183028401116401000000008311171561010457600080fd5b509092509050610217565b6040805173ffffffffffffffffffffffffffffffffffffffff9092168252519081900360200190f35b34801561014457600080fd5b5061010f6004803603604081101561015b57600080fd5b8135919081019060408101602082013564010000000081111561017d57600080fd5b82018360208201111561018f57600080fd5b803590602001918460018302840111640100000000831117156101b157600080fd5b509092509050610592565b3480156101c857600080fd5b5061010f600480360360408110156101df57600080fd5b508035906020013561069e565b73ffffffffffffffffffffffffffffffffffffffff1660009081526020819052604090205460ff1690565b600083606081901c33148061024c57507fffffffffffffffffffffffffffffffffffffffff0000000000000000000000008116155b6102a1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260458152602001806107746045913960600191505060405180910390fd5b606084848080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920182905250604051855195965090943094508b93508692506020918201918291908401908083835b6020831061033557805182527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe090920191602091820191016102f8565b51815160209384036101000a7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff018019909216911617905260408051929094018281037fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe00183528085528251928201929092207fff000000000000000000000000000000000000000000000000000000000000008383015260609890981b7fffffffffffffffffffffffffffffffffffffffff00000000000000000000000016602183015260358201969096526055808201979097528251808203909701875260750182525084519484019490942073ffffffffffffffffffffffffffffffffffffffff81166000908152938490529390922054929350505060ff16156104a7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252603f815260200180610735603f913960400191505060405180910390fd5b81602001825188818334f5955050508073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff161461053a576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260468152602001806107b96046913960600191505060405180910390fd5b50505073ffffffffffffffffffffffffffffffffffffffff8116600090815260208190526040902080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff001660011790559392505050565b6000308484846040516020018083838082843760408051919093018181037fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe001825280845281516020928301207fff000000000000000000000000000000000000000000000000000000000000008383015260609990991b7fffffffffffffffffffffffffffffffffffffffff000000000000000000000000166021820152603581019790975260558088019890985282518088039098018852607590960182525085519585019590952073ffffffffffffffffffffffffffffffffffffffff81166000908152948590529490932054939450505060ff909116159050610697575060005b9392505050565b604080517fff000000000000000000000000000000000000000000000000000000000000006020808301919091523060601b6021830152603582018590526055808301859052835180840390910181526075909201835281519181019190912073ffffffffffffffffffffffffffffffffffffffff81166000908152918290529190205460ff161561072e575060005b9291505056fe496e76616c696420636f6e7472616374206372656174696f6e202d20636f6e74726163742068617320616c7265616479206265656e206465706c6f7965642e496e76616c69642073616c74202d206669727374203230206279746573206f66207468652073616c74206d757374206d617463682063616c6c696e6720616464726573732e4661696c656420746f206465706c6f7920636f6e7472616374207573696e672070726f76696465642073616c7420616e6420696e697469616c697a6174696f6e20636f64652ea265627a7a723058202bdc55310d97c4088f18acf04253db593f0914059f0c781a9df3624dcef0d1cf64736f6c634300050a0032";
            /// @solidity memory-safe-assembly
            assembly {
                let m := mload(0x40)
                mstore(m, 0xb4d6c782) // `etch(address,bytes)`.
                mstore(add(m, 0x20), c2f)
                mstore(add(m, 0x40), 0x40)
                let n := mload(ic2fBytecode)
                mstore(add(m, 0x60), n)
                for { let i := 0 } lt(i, n) { i := add(0x20, i) } {
                    mstore(add(add(m, 0x80), i), mload(add(add(ic2fBytecode, 0x20), i)))
                }
                let vmAddress := 0x7109709ECfa91a80626fF3989D68f67F5b1DD12D
                if iszero(call(gas(), vmAddress, 0, add(m, 0x1c), add(n, 0x64), 0x00, 0x00)) {
                    revert(0, 0)
                }
            }
        }
        /// @solidity memory-safe-assembly
        assembly {
            let m := mload(0x40)
            let n := mload($initializationCode)
            mstore(m, 0x64e03087) // `safeCreate2(bytes32,bytes)`.
            mstore(add(m, 0x20), $salt)
            mstore(add(m, 0x40), 0x40)
            mstore(add(m, 0x60), n)
            // prettier-ignore
            for { let i := 0 } lt(i, n) { i := add(i, 0x20) } {
                mstore(add(add(m, 0x80), i), mload(add(add($initializationCode, 0x20), i)))
            }
            if iszero(call(gas(), c2f, 0, add(m, 0x1c), add(n, 0x64), m, 0x20)) {
                returndatacopy(m, m, returndatasize())
                revert(m, returndatasize())
            }
            $deployment := mload(m)
        }
    }

    /**
     * @notice Determine and retrieve the extcodesize of `deployment`.
     * @param $deployment The address to check.
     * @return $result The size of the code at `deployment`.
     */
    function _extcodesize(address $deployment) private view returns (uint256 $result) {
        /// @solidity memory-safe-assembly
        assembly {
            $result := extcodesize($deployment)
        }
    }
}
